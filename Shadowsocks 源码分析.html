<header class="page-header" style="background-color: white; border-bottom: 0px; box-sizing: border-box; color: #333333; font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Segoe UI&quot;, Arial, freesans, sans-serif, &quot;Apple Color Emoji&quot;, &quot;Segoe UI Emoji&quot;, &quot;Segoe UI Symbol&quot;; font-size: 16px; margin: 20px 0px; padding: 0px;"><h1 style="border-bottom: 0px; box-sizing: border-box; color: inherit; font-family: inherit; font-size: 2.25em; line-height: 1.2; margin: 0px 0px 16px; padding-bottom: 0.3em;">
<a class="article-title" href="https://loggerhead.me/posts/shadowsocks-yuan-ma-fen-xi-xie-yi-yu-jie-gou.html" rel="bookmark" style="background-color: transparent; box-sizing: border-box; color: #4078c0; text-decoration-line: none;" title="Permalink to Shadowsocks 源码分析——协议与结构">Shadowsocks 源码分析——协议与结构</a></h1>
<footer class="post-info" style="box-sizing: border-box; color: #999999; font-size: 12px;"><div class="row" style="box-sizing: border-box; margin-left: -15px; margin-right: -15px;">
<div class="col-xs-8" style="box-sizing: border-box; float: left; min-height: 1px; padding-left: 15px; padding-right: 15px; position: relative; width: 585.328px;">
<a class="tag btn btn-xs" href="https://loggerhead.me/tag/yuan-ma-fen-xi.html" style="background-color: #999999; background-image: none; border-radius: 3px; border: 1px solid; box-sizing: border-box; color: white; display: inline-block; line-height: 1.5; margin-bottom: 0px; padding: 1px 5px; text-align: center; text-decoration-line: none; touch-action: manipulation; user-select: none; vertical-align: middle; white-space: nowrap;">源码分析</a>&nbsp;<a class="tag btn btn-xs" href="https://loggerhead.me/tag/python.html" style="background-color: #999999; background-image: none; border-radius: 3px; border: 1px solid; box-sizing: border-box; color: white; display: inline-block; line-height: 1.5; margin-bottom: 0px; padding: 1px 5px; text-align: center; text-decoration-line: none; touch-action: manipulation; user-select: none; vertical-align: middle; white-space: nowrap;">Python</a></div>
<div class="col-xs-4 time" style="box-sizing: border-box; float: left; font-size: 1.1em; min-height: 1px; padding-left: 0px; padding-right: 15px; position: relative; width: 292.656px;">
<time class="pull-right" datetime="2016-12-06T21:00:00+08:00" style="box-sizing: border-box; float: right !important;">2016-12-06</time></div>
</div>
</footer><hr style="background: rgb(170, 170, 170); border: 0px none; box-sizing: content-box; height: 1px; margin: 16px 0px 0px; padding: 0px;" />
</header><div class="entry-content" style="background-color: white; box-sizing: border-box; color: #333333; font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Segoe UI&quot;, Arial, freesans, sans-serif, &quot;Apple Color Emoji&quot;, &quot;Segoe UI Emoji&quot;, &quot;Segoe UI Symbol&quot;; font-size: 16px;">
<div style="box-sizing: border-box; margin-bottom: 16px;">
<a href="https://github.com/shadowsocks/shadowsocks/tree/master" style="background-color: transparent; box-sizing: border-box; color: #4078c0; text-decoration-line: none;">Shadowsocks</a>&nbsp;是一款著名的 SOCKS5 代理工具，深受人民群众喜爱。它的源码工程质量很高，十分便于研究。不过当你真正开始读源码的时候，会有一种似懂非懂的感觉，因为虽然它的大体框架容易理解，但是其中的诸多细节却不是那么简单明了。</div>
<div style="box-sizing: border-box; margin-bottom: 16px;">
本文将基于&nbsp;<a href="https://github.com/loggerhead/shadowsocks/tree/8e8ee5d490ce319b8db9b61001dac51a7da4be63" style="background-color: transparent; box-sizing: border-box; color: #4078c0; text-decoration-line: none;">2.9.0 版本的源码</a>对 shadowsocks 进行分析，希望读者看完以后能对 shadowsocks 的原理有个大体上的认识。为了行文简洁，在示例中我们用 ss 指代 shadowsocks。</div>
<div class="toc" style="box-sizing: border-box;">
<ul style="box-sizing: border-box; margin-bottom: 16px; margin-top: 0px; padding: 0px 0px 0px 2em;">
<li style="box-sizing: border-box;"><a href="https://loggerhead.me/posts/shadowsocks-yuan-ma-fen-xi-xie-yi-yu-jie-gou.html#socks5" style="background-color: transparent; box-sizing: border-box; color: #4078c0; text-decoration-line: none;">SOCKS5 协议</a><ul style="box-sizing: border-box; margin-bottom: 0px; margin-top: 0px; padding: 0px 0px 0px 2em;">
<li style="box-sizing: border-box;"><a href="https://loggerhead.me/posts/shadowsocks-yuan-ma-fen-xi-xie-yi-yu-jie-gou.html#_1" style="background-color: transparent; box-sizing: border-box; color: #4078c0; text-decoration-line: none;">握手阶段</a></li>
<li style="box-sizing: border-box;"><a href="https://loggerhead.me/posts/shadowsocks-yuan-ma-fen-xi-xie-yi-yu-jie-gou.html#_2" style="background-color: transparent; box-sizing: border-box; color: #4078c0; text-decoration-line: none;">建立连接</a></li>
<li style="box-sizing: border-box;"><a href="https://loggerhead.me/posts/shadowsocks-yuan-ma-fen-xi-xie-yi-yu-jie-gou.html#_3" style="background-color: transparent; box-sizing: border-box; color: #4078c0; text-decoration-line: none;">传输阶段</a></li>
</ul>
</li>
<li style="box-sizing: border-box;"><a href="https://loggerhead.me/posts/shadowsocks-yuan-ma-fen-xi-xie-yi-yu-jie-gou.html#_4" style="background-color: transparent; box-sizing: border-box; color: #4078c0; text-decoration-line: none;">整体结构</a></li>
<li style="box-sizing: border-box;"><a href="https://loggerhead.me/posts/shadowsocks-yuan-ma-fen-xi-xie-yi-yu-jie-gou.html#_5" style="background-color: transparent; box-sizing: border-box; color: #4078c0; text-decoration-line: none;">事件处理</a><ul style="box-sizing: border-box; margin-bottom: 0px; margin-top: 0px; padding: 0px 0px 0px 2em;">
<li style="box-sizing: border-box;"><a href="https://loggerhead.me/posts/shadowsocks-yuan-ma-fen-xi-xie-yi-yu-jie-gou.html#eventlooppy" style="background-color: transparent; box-sizing: border-box; color: #4078c0; text-decoration-line: none;">eventloop.py</a></li>
<li style="box-sizing: border-box;"><a href="https://loggerhead.me/posts/shadowsocks-yuan-ma-fen-xi-xie-yi-yu-jie-gou.html#tcprelaypy" style="background-color: transparent; box-sizing: border-box; color: #4078c0; text-decoration-line: none;">tcprelay.py</a></li>
<li style="box-sizing: border-box;"><a href="https://loggerhead.me/posts/shadowsocks-yuan-ma-fen-xi-xie-yi-yu-jie-gou.html#udprelaypy" style="background-color: transparent; box-sizing: border-box; color: #4078c0; text-decoration-line: none;">udprelay.py</a></li>
<li style="box-sizing: border-box;"><a href="https://loggerhead.me/posts/shadowsocks-yuan-ma-fen-xi-xie-yi-yu-jie-gou.html#asyncdnspy" style="background-color: transparent; box-sizing: border-box; color: #4078c0; text-decoration-line: none;">asyncdns.py</a></li>
</ul>
</li>
<li style="box-sizing: border-box;"><a href="https://loggerhead.me/posts/shadowsocks-yuan-ma-fen-xi-xie-yi-yu-jie-gou.html#_6" style="background-color: transparent; box-sizing: border-box; color: #4078c0; text-decoration-line: none;">总结</a></li>
</ul>
</div>
<h1 id="socks5" style="border-bottom: 1px solid rgb(238, 238, 238); box-sizing: border-box; color: inherit; font-family: inherit; font-size: 2.25em; line-height: 1.2; margin: 1em 0px 16px; padding-bottom: 0.3em;">
SOCKS5 协议</h1>
<div style="box-sizing: border-box; margin-bottom: 16px;">
无论是实现什么网络应用，首当其冲的就是确定通讯协议。SOCKS5 协议作为一个同时支持 TCP 和 UDP 的应用层协议（<a href="https://www.ietf.org/rfc/rfc1928.txt" style="background-color: transparent; box-sizing: border-box; color: #4078c0; text-decoration-line: none;">RFC</a>&nbsp;只有短短的 7 页），因为其简单易用的特性而被 shadowsocks 青睐。我们先从 SOCKS5 协议入手，一点一点剖析 shadowsocks。</div>
<h2 id="_1" style="border-bottom: 1px solid rgb(238, 238, 238); box-sizing: border-box; color: inherit; font-family: inherit; font-size: 1.75em; line-height: 1.225; margin-bottom: 16px; margin-top: 1em; padding-bottom: 0.3em;">
握手阶段</h2>
<div style="box-sizing: border-box; margin-bottom: 16px;">
客户端和服务器在握手阶段协商认证方式，比如：是否采用用户名/密码的方式进行认证，或者不采用任何认证方式。</div>
<div style="box-sizing: border-box; margin-bottom: 16px;">
客户端发送给服务器的消息格式如下（数字表示对应字段占用的字节数）：</div>
<table class="highlighttable" style="background-color: inherit; border-collapse: collapse; border-radius: 3px; border-spacing: 0px; border: 1px solid rgb(204, 204, 204); box-sizing: border-box; display: block; margin-bottom: 16px; margin-top: 0px; overflow: auto; width: 848px; word-break: keep-all;"><tbody style="box-sizing: border-box;">
<tr style="background-color: inherit; border: 0px; box-sizing: border-box;"><td class="linenos" style="background-color: #f7f7f7; border-bottom-color: initial; border-bottom-style: initial; border-image: initial; border-left-color: initial; border-left-style: initial; border-right-color: rgb(221, 221, 221); border-right-style: solid; border-top-color: initial; border-top-style: initial; border-width: 0px 1px 0px 0px; box-sizing: border-box; margin: 0px; padding: 0px;"><div class="linenodiv" style="box-sizing: border-box;">
<pre style="background-color: inherit; border-radius: 3px; border: 0px; box-sizing: border-box; color: #aaaaaa; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: 1.45; overflow: initial; padding: 16px; word-break: break-all; word-wrap: normal;">1
2
3
4
5</pre>
</div>
</td><td class="code" style="border: 0px; box-sizing: border-box; margin: 0px; padding: 0px; width: 806px;"><div class="highlight" style="border: 0px; box-sizing: border-box; margin: 0px;">
<pre style="background-color: inherit; border-radius: 3px; border: 0px; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: 1.45; overflow: initial; padding: 16px; word-break: normal; word-wrap: normal;"><span style="box-sizing: border-box;"></span>+----+----------+----------+
|VER | NMETHODS | METHODS  |
+----+----------+----------+
| 1  |    1     |  1~255   |
+----+----------+----------+
</pre>
</div>
</td></tr>
</tbody></table>
<ul style="box-sizing: border-box; margin-bottom: 16px; margin-top: 0px; padding: 0px 0px 0px 2em;">
<li style="box-sizing: border-box;"><code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">VER</code>&nbsp;字段是当前协议的版本号，也就是&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">5</code>；</li>
<li style="box-sizing: border-box;"><code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">NMETHODS</code>&nbsp;字段是&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">METHODS</code>&nbsp;字段占用的字节数；</li>
<li style="box-sizing: border-box;"><code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">METHODS</code>&nbsp;字段的每一个字节表示一种认证方式，表示客户端支持的全部认证方式。</li>
</ul>
<div style="box-sizing: border-box; margin-bottom: 16px;">
服务器在收到客户端的协商请求后，会检查是否有服务器支持的认证方式，并返回客户端如下格式的消息：</div>
<table class="highlighttable" style="background-color: inherit; border-collapse: collapse; border-radius: 3px; border-spacing: 0px; border: 1px solid rgb(204, 204, 204); box-sizing: border-box; display: block; margin-bottom: 16px; margin-top: 0px; overflow: auto; width: 848px; word-break: keep-all;"><tbody style="box-sizing: border-box;">
<tr style="background-color: inherit; border: 0px; box-sizing: border-box;"><td class="linenos" style="background-color: #f7f7f7; border-bottom-color: initial; border-bottom-style: initial; border-image: initial; border-left-color: initial; border-left-style: initial; border-right-color: rgb(221, 221, 221); border-right-style: solid; border-top-color: initial; border-top-style: initial; border-width: 0px 1px 0px 0px; box-sizing: border-box; margin: 0px; padding: 0px;"><div class="linenodiv" style="box-sizing: border-box;">
<pre style="background-color: inherit; border-radius: 3px; border: 0px; box-sizing: border-box; color: #aaaaaa; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: 1.45; overflow: initial; padding: 16px; word-break: break-all; word-wrap: normal;">1
2
3
4
5</pre>
</div>
</td><td class="code" style="border: 0px; box-sizing: border-box; margin: 0px; padding: 0px; width: 806px;"><div class="highlight" style="border: 0px; box-sizing: border-box; margin: 0px;">
<pre style="background-color: inherit; border-radius: 3px; border: 0px; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: 1.45; overflow: initial; padding: 16px; word-break: normal; word-wrap: normal;"><span style="box-sizing: border-box;"></span>+----+--------+
|VER | METHOD |
+----+--------+
| 1  |   1    |
+----+--------+
</pre>
</div>
</td></tr>
</tbody></table>
<div style="box-sizing: border-box; margin-bottom: 16px;">
对于 shadowsocks 而言，返回给客户端的值只有两种可能：</div>
<ul style="box-sizing: border-box; margin-bottom: 16px; margin-top: 0px; padding: 0px 0px 0px 2em;">
<li style="box-sizing: border-box;"><code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">0x05 0x00</code>：告诉客户端采用无认证的方式建立连接；</li>
<li style="box-sizing: border-box;"><code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">0x05 0xff</code>：客户端的任意一种认证方式服务器都不支持。</li>
</ul>
<div style="box-sizing: border-box; margin-bottom: 16px;">
举个例子，就 shadowsocks 而言，最简单的握手可能是这样的：</div>
<table class="highlighttable" style="background-color: inherit; border-collapse: collapse; border-radius: 3px; border-spacing: 0px; border: 1px solid rgb(204, 204, 204); box-sizing: border-box; display: block; margin-bottom: 16px; margin-top: 0px; overflow: auto; width: 848px; word-break: keep-all;"><tbody style="box-sizing: border-box;">
<tr style="background-color: inherit; border: 0px; box-sizing: border-box;"><td class="linenos" style="background-color: #f7f7f7; border-bottom-color: initial; border-bottom-style: initial; border-image: initial; border-left-color: initial; border-left-style: initial; border-right-color: rgb(221, 221, 221); border-right-style: solid; border-top-color: initial; border-top-style: initial; border-width: 0px 1px 0px 0px; box-sizing: border-box; margin: 0px; padding: 0px;"><div class="linenodiv" style="box-sizing: border-box;">
<pre style="background-color: inherit; border-radius: 3px; border: 0px; box-sizing: border-box; color: #aaaaaa; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: 1.45; overflow: initial; padding: 16px; word-break: break-all; word-wrap: normal;">1
2</pre>
</div>
</td><td class="code" style="border: 0px; box-sizing: border-box; margin: 0px; padding: 0px; width: 806px;"><div class="highlight" style="border: 0px; box-sizing: border-box; margin: 0px;">
<pre style="background-color: inherit; border-radius: 3px; border: 0px; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: 1.45; overflow: initial; padding: 16px; word-break: normal; word-wrap: normal;"><span style="box-sizing: border-box;"></span><span class="n" style="box-sizing: border-box;">client</span> <span class="o" style="box-sizing: border-box; color: #303030;">-&gt;</span> <span class="n" style="box-sizing: border-box;">ss</span><span class="p" style="box-sizing: border-box;">:</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x05</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x01</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x00</span>
<span class="n" style="box-sizing: border-box;">ss</span> <span class="o" style="box-sizing: border-box; color: #303030;">-&gt;</span> <span class="n" style="box-sizing: border-box;">client</span><span class="p" style="box-sizing: border-box;">:</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x05</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x00</span>
</pre>
</div>
</td></tr>
</tbody></table>
<div style="box-sizing: border-box; margin-bottom: 16px;">
如果客户端<strong style="box-sizing: border-box; color: black;">还</strong>支持用户名/密码的认证方式，那么握手会是这样子：</div>
<table class="highlighttable" style="background-color: inherit; border-collapse: collapse; border-radius: 3px; border-spacing: 0px; border: 1px solid rgb(204, 204, 204); box-sizing: border-box; display: block; margin-bottom: 16px; margin-top: 0px; overflow: auto; width: 848px; word-break: keep-all;"><tbody style="box-sizing: border-box;">
<tr style="background-color: inherit; border: 0px; box-sizing: border-box;"><td class="linenos" style="background-color: #f7f7f7; border-bottom-color: initial; border-bottom-style: initial; border-image: initial; border-left-color: initial; border-left-style: initial; border-right-color: rgb(221, 221, 221); border-right-style: solid; border-top-color: initial; border-top-style: initial; border-width: 0px 1px 0px 0px; box-sizing: border-box; margin: 0px; padding: 0px;"><div class="linenodiv" style="box-sizing: border-box;">
<pre style="background-color: inherit; border-radius: 3px; border: 0px; box-sizing: border-box; color: #aaaaaa; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: 1.45; overflow: initial; padding: 16px; word-break: break-all; word-wrap: normal;">1
2</pre>
</div>
</td><td class="code" style="border: 0px; box-sizing: border-box; margin: 0px; padding: 0px; width: 806px;"><div class="highlight" style="border: 0px; box-sizing: border-box; margin: 0px;">
<pre style="background-color: inherit; border-radius: 3px; border: 0px; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: 1.45; overflow: initial; padding: 16px; word-break: normal; word-wrap: normal;"><span style="box-sizing: border-box;"></span><span class="n" style="box-sizing: border-box;">client</span> <span class="o" style="box-sizing: border-box; color: #303030;">-&gt;</span> <span class="n" style="box-sizing: border-box;">ss</span><span class="p" style="box-sizing: border-box;">:</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x05</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x02</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x00</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x02</span>
<span class="n" style="box-sizing: border-box;">ss</span> <span class="o" style="box-sizing: border-box; color: #303030;">-&gt;</span> <span class="n" style="box-sizing: border-box;">client</span><span class="p" style="box-sizing: border-box;">:</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x05</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x00</span>
</pre>
</div>
</td></tr>
</tbody></table>
<div style="box-sizing: border-box; margin-bottom: 16px;">
如果客户端<strong style="box-sizing: border-box; color: black;">只</strong>支持用户名/密码的认证方式，那么握手会是这样子：</div>
<table class="highlighttable" style="background-color: inherit; border-collapse: collapse; border-radius: 3px; border-spacing: 0px; border: 1px solid rgb(204, 204, 204); box-sizing: border-box; display: block; margin-bottom: 16px; margin-top: 0px; overflow: auto; width: 848px; word-break: keep-all;"><tbody style="box-sizing: border-box;">
<tr style="background-color: inherit; border: 0px; box-sizing: border-box;"><td class="linenos" style="background-color: #f7f7f7; border-bottom-color: initial; border-bottom-style: initial; border-image: initial; border-left-color: initial; border-left-style: initial; border-right-color: rgb(221, 221, 221); border-right-style: solid; border-top-color: initial; border-top-style: initial; border-width: 0px 1px 0px 0px; box-sizing: border-box; margin: 0px; padding: 0px;"><div class="linenodiv" style="box-sizing: border-box;">
<pre style="background-color: inherit; border-radius: 3px; border: 0px; box-sizing: border-box; color: #aaaaaa; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: 1.45; overflow: initial; padding: 16px; word-break: break-all; word-wrap: normal;">1
2</pre>
</div>
</td><td class="code" style="border: 0px; box-sizing: border-box; margin: 0px; padding: 0px; width: 806px;"><div class="highlight" style="border: 0px; box-sizing: border-box; margin: 0px;">
<pre style="background-color: inherit; border-radius: 3px; border: 0px; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: 1.45; overflow: initial; padding: 16px; word-break: normal; word-wrap: normal;"><span style="box-sizing: border-box;"></span><span class="n" style="box-sizing: border-box;">client</span> <span class="o" style="box-sizing: border-box; color: #303030;">-&gt;</span> <span class="n" style="box-sizing: border-box;">ss</span><span class="p" style="box-sizing: border-box;">:</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x05</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x01</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x02</span>
<span class="n" style="box-sizing: border-box;">ss</span> <span class="o" style="box-sizing: border-box; color: #303030;">-&gt;</span> <span class="n" style="box-sizing: border-box;">client</span><span class="p" style="box-sizing: border-box;">:</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x05</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0xff</span>
</pre>
</div>
</td></tr>
</tbody></table>
<h2 id="_2" style="border-bottom: 1px solid rgb(238, 238, 238); box-sizing: border-box; color: inherit; font-family: inherit; font-size: 1.75em; line-height: 1.225; margin-bottom: 16px; margin-top: 1em; padding-bottom: 0.3em;">
建立连接</h2>
<div style="box-sizing: border-box; margin-bottom: 16px;">
完成握手后，客户端会向服务器发起请求，请求的格式如下：</div>
<table class="highlighttable" style="background-color: inherit; border-collapse: collapse; border-radius: 3px; border-spacing: 0px; border: 1px solid rgb(204, 204, 204); box-sizing: border-box; display: block; margin-bottom: 16px; margin-top: 0px; overflow: auto; width: 848px; word-break: keep-all;"><tbody style="box-sizing: border-box;">
<tr style="background-color: inherit; border: 0px; box-sizing: border-box;"><td class="linenos" style="background-color: #f7f7f7; border-bottom-color: initial; border-bottom-style: initial; border-image: initial; border-left-color: initial; border-left-style: initial; border-right-color: rgb(221, 221, 221); border-right-style: solid; border-top-color: initial; border-top-style: initial; border-width: 0px 1px 0px 0px; box-sizing: border-box; margin: 0px; padding: 0px;"><div class="linenodiv" style="box-sizing: border-box;">
<pre style="background-color: inherit; border-radius: 3px; border: 0px; box-sizing: border-box; color: #aaaaaa; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: 1.45; overflow: initial; padding: 16px; word-break: break-all; word-wrap: normal;">1
2
3
4
5</pre>
</div>
</td><td class="code" style="border: 0px; box-sizing: border-box; margin: 0px; padding: 0px; width: 806px;"><div class="highlight" style="border: 0px; box-sizing: border-box; margin: 0px;">
<pre style="background-color: inherit; border-radius: 3px; border: 0px; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: 1.45; overflow: initial; padding: 16px; word-break: normal; word-wrap: normal;"><span style="box-sizing: border-box;"></span>+----+-----+-------+------+----------+----------+
|VER | CMD |  RSV  | ATYP | DST.ADDR | DST.PORT |
+----+-----+-------+------+----------+----------+
| 1  |  1  |   1   |  1   | Variable |    2     |
+----+-----+-------+------+----------+----------+
</pre>
</div>
</td></tr>
</tbody></table>
<ul style="box-sizing: border-box; margin-bottom: 16px; margin-top: 0px; padding: 0px 0px 0px 2em;">
<li style="box-sizing: border-box;"><code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">CMD</code>&nbsp;字段：<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">command</code>&nbsp;的缩写，shadowsocks 只用到了：<ul style="box-sizing: border-box; margin-bottom: 0px; margin-top: 0px; padding: 0px 0px 0px 2em;">
<li style="box-sizing: border-box;"><code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">0x01</code>：建立 TCP 连接</li>
<li style="box-sizing: border-box;"><code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">0x03</code>：关联 UDP 请求</li>
</ul>
</li>
<li style="box-sizing: border-box;"><code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">RSV</code>&nbsp;字段：保留字段，值为&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">0x00</code>；</li>
<li style="box-sizing: border-box;"><code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">ATYP</code>&nbsp;字段：<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">address type</code>&nbsp;的缩写，取值为：<ul style="box-sizing: border-box; margin-bottom: 0px; margin-top: 0px; padding: 0px 0px 0px 2em;">
<li style="box-sizing: border-box;"><code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">0x01</code>：IPv4</li>
<li style="box-sizing: border-box;"><code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">0x03</code>：域名</li>
<li style="box-sizing: border-box;"><code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">0x04</code>：IPv6</li>
</ul>
</li>
<li style="box-sizing: border-box;"><code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">DST.ADDR</code>&nbsp;字段：<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">destination address</code>&nbsp;的缩写，取值随&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">ATYP</code>&nbsp;变化：<ul style="box-sizing: border-box; margin-bottom: 0px; margin-top: 0px; padding: 0px 0px 0px 2em;">
<li style="box-sizing: border-box;"><code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">ATYP == 0x01</code>：4 个字节的 IPv4 地址</li>
<li style="box-sizing: border-box;"><code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">ATYP == 0x03</code>：1 个字节表示域名长度，紧随其后的是对应的域名</li>
<li style="box-sizing: border-box;"><code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">ATYP == 0x04</code>：16 个字节的 IPv6 地址</li>
</ul>
</li>
<li style="box-sizing: border-box;"><code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">DST.PORT</code>&nbsp;字段：目的服务器的端口。</li>
</ul>
<div style="box-sizing: border-box; margin-bottom: 16px;">
在收到客户端的请求后，服务器会返回如下格式的消息：</div>
<table class="highlighttable" style="background-color: inherit; border-collapse: collapse; border-radius: 3px; border-spacing: 0px; border: 1px solid rgb(204, 204, 204); box-sizing: border-box; display: block; margin-bottom: 16px; margin-top: 0px; overflow: auto; width: 848px; word-break: keep-all;"><tbody style="box-sizing: border-box;">
<tr style="background-color: inherit; border: 0px; box-sizing: border-box;"><td class="linenos" style="background-color: #f7f7f7; border-bottom-color: initial; border-bottom-style: initial; border-image: initial; border-left-color: initial; border-left-style: initial; border-right-color: rgb(221, 221, 221); border-right-style: solid; border-top-color: initial; border-top-style: initial; border-width: 0px 1px 0px 0px; box-sizing: border-box; margin: 0px; padding: 0px;"><div class="linenodiv" style="box-sizing: border-box;">
<pre style="background-color: inherit; border-radius: 3px; border: 0px; box-sizing: border-box; color: #aaaaaa; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: 1.45; overflow: initial; padding: 16px; word-break: break-all; word-wrap: normal;">1
2
3
4
5</pre>
</div>
</td><td class="code" style="border: 0px; box-sizing: border-box; margin: 0px; padding: 0px; width: 806px;"><div class="highlight" style="border: 0px; box-sizing: border-box; margin: 0px;">
<pre style="background-color: inherit; border-radius: 3px; border: 0px; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: 1.45; overflow: initial; padding: 16px; word-break: normal; word-wrap: normal;"><span style="box-sizing: border-box;"></span>+----+-----+-------+------+----------+----------+
|VER | REP |  RSV  | ATYP | BND.ADDR | BND.PORT |
+----+-----+-------+------+----------+----------+
| 1  |  1  |   1   |  1   | Variable |    2     |
+----+-----+-------+------+----------+----------+
</pre>
</div>
</td></tr>
</tbody></table>
<ul style="box-sizing: border-box; margin-bottom: 16px; margin-top: 0px; padding: 0px 0px 0px 2em;">
<li style="box-sizing: border-box;"><code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">REP</code>&nbsp;字段：用以告知客户端请求处理情况。在请求处理成功的情况下，shadowsocks 将这个字段的值设为&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">0x00</code>，否则，shadowsocks 会直接断开连接；</li>
<li style="box-sizing: border-box;">其它字段和请求中字段的取值类型一样。</li>
</ul>
<div style="box-sizing: border-box; margin-bottom: 16px;">
举例来说，如果客户端通过 shadowsocks 代理&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">127.0.0.1:8000</code>&nbsp;的请求，那么客户端和 shadowsocks 之间的请求和响应是这样的：</div>
<table class="highlighttable" style="background-color: inherit; border-collapse: collapse; border-radius: 3px; border-spacing: 0px; border: 1px solid rgb(204, 204, 204); box-sizing: border-box; display: block; margin-bottom: 16px; margin-top: 0px; overflow: auto; width: 848px; word-break: keep-all;"><tbody style="box-sizing: border-box;">
<tr style="background-color: inherit; border: 0px; box-sizing: border-box;"><td class="linenos" style="background-color: #f7f7f7; border-bottom-color: initial; border-bottom-style: initial; border-image: initial; border-left-color: initial; border-left-style: initial; border-right-color: rgb(221, 221, 221); border-right-style: solid; border-top-color: initial; border-top-style: initial; border-width: 0px 1px 0px 0px; box-sizing: border-box; margin: 0px; padding: 0px;"><div class="linenodiv" style="box-sizing: border-box;">
<pre style="background-color: inherit; border-radius: 3px; border: 0px; box-sizing: border-box; color: #aaaaaa; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: 1.45; overflow: initial; padding: 16px; word-break: break-all; word-wrap: normal;">1
2
3
4</pre>
</div>
</td><td class="code" style="border: 0px; box-sizing: border-box; margin: 0px; padding: 0px; width: 806px;"><div class="highlight" style="border: 0px; box-sizing: border-box; margin: 0px;">
<pre style="background-color: inherit; border-radius: 3px; border: 0px; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: 1.45; overflow: initial; padding: 16px; word-break: normal; word-wrap: normal;"><span style="box-sizing: border-box;"></span><span class="c1" style="box-sizing: border-box; color: grey;">#    request: VER  CMD  RSV  ATYP DST.ADDR            DST.PORT</span>
<span class="n" style="box-sizing: border-box;">client</span> <span class="o" style="box-sizing: border-box; color: #303030;">-&gt;</span> <span class="n" style="box-sizing: border-box;">ss</span><span class="p" style="box-sizing: border-box;">:</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x05</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x01</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x00</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x01</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x7f</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x00</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x00</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x01</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x1f</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x40</span>
<span class="c1" style="box-sizing: border-box; color: grey;">#   response: VER  REP  RSV  ATYP BND.ADDR            BND.PORT</span>
<span class="n" style="box-sizing: border-box;">ss</span> <span class="o" style="box-sizing: border-box; color: #303030;">-&gt;</span> <span class="n" style="box-sizing: border-box;">client</span><span class="p" style="box-sizing: border-box;">:</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x05</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x00</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x00</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x01</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x00</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x00</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x00</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x00</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x10</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x10</span>
</pre>
</div>
</td></tr>
</tbody></table>
<div style="box-sizing: border-box; margin-bottom: 16px;">
这里&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">0x7f 0x00 0x00 0x01 0x1f 0x40</code>&nbsp;对应的是&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">127.0.0.1:8000</code>。需要注意的是，当请求中的&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">CMD == 0x01</code>&nbsp;时，绝大部分 SOCKS5 客户端的实现都会忽略 SOCKS5 服务器返回的&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">BND.ADDR</code>&nbsp;和&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">BND.PORT</code>&nbsp;字段，所以这里的&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">0x00 0x00 0x00 0x00 0x10 0x10</code>&nbsp;只是 shadowsocks 返回的一个无意义的地址和端口<span id="fnref:bnd.addr" style="box-sizing: border-box; font-size: 12px; line-height: 0; position: relative; top: -0.5em; vertical-align: baseline;"><a class="footnote-ref" href="https://loggerhead.me/posts/shadowsocks-yuan-ma-fen-xi-xie-yi-yu-jie-gou.html#fn:bnd.addr" rel="footnote" style="background-color: transparent; box-sizing: border-box; color: #4078c0; text-decoration-line: none;">1</a></span>。</div>
<h2 id="_3" style="border-bottom: 1px solid rgb(238, 238, 238); box-sizing: border-box; color: inherit; font-family: inherit; font-size: 1.75em; line-height: 1.225; margin-bottom: 16px; margin-top: 1em; padding-bottom: 0.3em;">
传输阶段</h2>
<div style="box-sizing: border-box; margin-bottom: 16px;">
SOCKS5 协议只负责建立连接，在完成握手阶段和建立连接之后，SOCKS5 服务器就只做简单的转发了。假如客户端通过 shadowsocks 代理&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">google.com:80</code>（用&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">remote</code>&nbsp;表示），那么整个过程如图所示：</div>
<div style="box-sizing: border-box; margin-bottom: 16px;">
<img alt="socks example" src="https://cdn.loggerhead.me/images/socks5-example.svg" style="border: 0px; box-sizing: content-box; max-width: 80%; vertical-align: middle;" /></div>
<div style="box-sizing: border-box; margin-bottom: 16px;">
整个过程中发生的传输可能是这样的：</div>
<table class="highlighttable" style="background-color: inherit; border-collapse: collapse; border-radius: 3px; border-spacing: 0px; border: 1px solid rgb(204, 204, 204); box-sizing: border-box; display: block; margin-bottom: 16px; margin-top: 0px; overflow: auto; width: 848px; word-break: keep-all;"><tbody style="box-sizing: border-box;">
<tr style="background-color: inherit; border: 0px; box-sizing: border-box;"><td class="linenos" style="background-color: #f7f7f7; border-bottom-color: initial; border-bottom-style: initial; border-image: initial; border-left-color: initial; border-left-style: initial; border-right-color: rgb(221, 221, 221); border-right-style: solid; border-top-color: initial; border-top-style: initial; border-width: 0px 1px 0px 0px; box-sizing: border-box; margin: 0px; padding: 0px;"><div class="linenodiv" style="box-sizing: border-box;">
<pre style="background-color: inherit; border-radius: 3px; border: 0px; box-sizing: border-box; color: #aaaaaa; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: 1.45; overflow: initial; padding: 16px; word-break: break-all; word-wrap: normal;"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre>
</div>
</td><td class="code" style="border: 0px; box-sizing: border-box; margin: 0px; padding: 0px; width: 799px;"><div class="highlight" style="border: 0px; box-sizing: border-box; margin: 0px;">
<pre style="background-color: inherit; border-radius: 3px; border: 0px; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: 1.45; overflow: initial; padding: 16px; word-break: normal; word-wrap: normal;"><span style="box-sizing: border-box;"></span><span class="c1" style="box-sizing: border-box; color: grey;"># 握手阶段</span>
<span class="n" style="box-sizing: border-box;">client</span> <span class="o" style="box-sizing: border-box; color: #303030;">-&gt;</span> <span class="n" style="box-sizing: border-box;">ss</span><span class="p" style="box-sizing: border-box;">:</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x05</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x01</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x00</span>
<span class="n" style="box-sizing: border-box;">ss</span> <span class="o" style="box-sizing: border-box; color: #303030;">-&gt;</span> <span class="n" style="box-sizing: border-box;">client</span><span class="p" style="box-sizing: border-box;">:</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x05</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x00</span>
<span class="c1" style="box-sizing: border-box; color: grey;"># 建立连接</span>
<span class="n" style="box-sizing: border-box;">client</span> <span class="o" style="box-sizing: border-box; color: #303030;">-&gt;</span> <span class="n" style="box-sizing: border-box;">ss</span><span class="p" style="box-sizing: border-box;">:</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x05</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x01</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x00</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x03</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x0a</span> <span class="n" style="box-sizing: border-box;">b</span><span class="s1" style="background-color: #fff0f0; box-sizing: border-box;">'google.com'</span>  <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x00</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x50</span>
<span class="n" style="box-sizing: border-box;">ss</span> <span class="o" style="box-sizing: border-box; color: #303030;">-&gt;</span> <span class="n" style="box-sizing: border-box;">client</span><span class="p" style="box-sizing: border-box;">:</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x05</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x00</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x00</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x01</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x00</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x00</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x00</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x00</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x10</span> <span class="mh" style="box-sizing: border-box; color: #005080; font-weight: bold;">0x10</span>
<span class="c1" style="box-sizing: border-box; color: grey;"># 传输阶段</span>
<span class="n" style="box-sizing: border-box;">client</span> <span class="o" style="box-sizing: border-box; color: #303030;">-&gt;</span> <span class="n" style="box-sizing: border-box;">ss</span> <span class="o" style="box-sizing: border-box; color: #303030;">-&gt;</span> <span class="n" style="box-sizing: border-box;">remote</span>
<span class="n" style="box-sizing: border-box;">remote</span> <span class="o" style="box-sizing: border-box; color: #303030;">-&gt;</span> <span class="n" style="box-sizing: border-box;">ss</span> <span class="o" style="box-sizing: border-box; color: #303030;">-&gt;</span> <span class="n" style="box-sizing: border-box;">client</span>
<span class="o" style="box-sizing: border-box; color: #303030;">...</span>
</pre>
</div>
</td></tr>
</tbody></table>
<div style="box-sizing: border-box; margin-bottom: 16px;">
<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">b'google.com'</code>&nbsp;表示&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">google.com</code>&nbsp;对应的 ASCII 码。</div>
<h1 id="_4" style="border-bottom: 1px solid rgb(238, 238, 238); box-sizing: border-box; color: inherit; font-family: inherit; font-size: 2.25em; line-height: 1.2; margin: 1em 0px 16px; padding-bottom: 0.3em;">
整体结构</h1>
<div style="box-sizing: border-box; margin-bottom: 16px;">
在进一步了解 shadowsocks 的内部构造之前，我们粗略的看一下各个模块分别做了些什么：</div>
<ul style="box-sizing: border-box; margin-bottom: 16px; margin-top: 0px; padding: 0px 0px 0px 2em;">
<li style="box-sizing: border-box;"><code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">tcprelay.py</code>：核心部分，整个 SOCKS5 协议的实现都在这里。负责 TCP 代理的实现；</li>
<li style="box-sizing: border-box;"><code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">udprelay.py</code>：负责 UDP 代理的实现；</li>
<li style="box-sizing: border-box;"><code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">asyncdns.py</code>：实现了简单的异步 DNS 查询；</li>
<li style="box-sizing: border-box;"><code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">eventloop.py</code>：封装了三种常见的 IO 复用函数——<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">epoll</code>、<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">kqueue</code>&nbsp;和&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">select</code>，提供统一的接口；</li>
<li style="box-sizing: border-box;"><code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">encrypt.py</code>：提供统一的加密解密接口；</li>
<li style="box-sizing: border-box;"><code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">crypto</code>：封装了多种加密库的调用，包括 OpenSSL 和 libsodium；</li>
<li style="box-sizing: border-box;"><code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">daemon.py</code>：用于实现守护进程；</li>
<li style="box-sizing: border-box;"><code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">shell.py</code>：读取命令行参数，检查配置；</li>
<li style="box-sizing: border-box;"><code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">common.py</code>：提供一些工具函数，比如：将&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">bytes</code>&nbsp;转换成&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">str</code>、解析 SOCKS5 请求；</li>
<li style="box-sizing: border-box;"><code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">lru_cache.py</code>：实现了&nbsp;<a href="https://en.wikipedia.org/wiki/Cache_replacement_policies#Least_Recently_Used_.28LRU.29" style="background-color: transparent; box-sizing: border-box; color: #4078c0; text-decoration-line: none;">LRU 缓存</a>；</li>
<li style="box-sizing: border-box;"><code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">local.py</code>：shadowsocks 客户端（即&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">sslocal</code>&nbsp;命令）的入口；</li>
<li style="box-sizing: border-box;"><code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">server.py</code>：shadowsocks 服务器（即&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">ssserver</code>&nbsp;命令）的入口。</li>
</ul>
<div style="box-sizing: border-box; margin-bottom: 16px;">
sslocal 和 ssserver 复用了绝大部分的代码，所以两者的运行流程都可以用伪代码表示为：</div>
<table class="highlighttable" style="background-color: inherit; border-collapse: collapse; border-radius: 3px; border-spacing: 0px; border: 1px solid rgb(204, 204, 204); box-sizing: border-box; display: block; margin-bottom: 16px; margin-top: 0px; overflow: auto; width: 848px; word-break: keep-all;"><tbody style="box-sizing: border-box;">
<tr style="background-color: inherit; border: 0px; box-sizing: border-box;"><td class="linenos" style="background-color: #f7f7f7; border-bottom-color: initial; border-bottom-style: initial; border-image: initial; border-left-color: initial; border-left-style: initial; border-right-color: rgb(221, 221, 221); border-right-style: solid; border-top-color: initial; border-top-style: initial; border-width: 0px 1px 0px 0px; box-sizing: border-box; margin: 0px; padding: 0px;"><div class="linenodiv" style="box-sizing: border-box;">
<pre style="background-color: inherit; border-radius: 3px; border: 0px; box-sizing: border-box; color: #aaaaaa; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: 1.45; overflow: initial; padding: 16px; word-break: break-all; word-wrap: normal;"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre>
</div>
</td><td class="code" style="border: 0px; box-sizing: border-box; margin: 0px; padding: 0px; width: 799px;"><div class="highlight" style="border: 0px; box-sizing: border-box; margin: 0px;">
<pre style="background-color: inherit; border-radius: 3px; border: 0px; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: 1.45; overflow: initial; padding: 16px; word-break: normal; word-wrap: normal;"><span style="box-sizing: border-box;"></span><span class="c1" style="box-sizing: border-box; color: grey;"># local.py or server.py</span>
<span class="k" style="box-sizing: border-box; color: green; font-weight: bold;">def</span> <span class="nf" style="box-sizing: border-box; color: #0060b0; font-weight: bold;">main</span><span class="p" style="box-sizing: border-box;">():</span>
    <span class="c1" style="box-sizing: border-box; color: grey;"># 解析命令行和配置文件中的参数</span>
    <span class="n" style="box-sizing: border-box;">conf</span> <span class="o" style="box-sizing: border-box; color: #303030;">=</span> <span class="n" style="box-sizing: border-box;">shell</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">parse_config</span><span class="p" style="box-sizing: border-box;">()</span>
    <span class="c1" style="box-sizing: border-box; color: grey;"># 根据配置决定要不要以守护进程的方式运行</span>
    <span class="n" style="box-sizing: border-box;">daemon</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">daemonize</span><span class="p" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">conf</span><span class="p" style="box-sizing: border-box;">)</span>

    <span class="n" style="box-sizing: border-box;">loop</span> <span class="o" style="box-sizing: border-box; color: #303030;">=</span> <span class="n" style="box-sizing: border-box;">eventloop</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">init</span><span class="p" style="box-sizing: border-box;">()</span>
    <span class="n" style="box-sizing: border-box;">tcp_server</span> <span class="o" style="box-sizing: border-box; color: #303030;">=</span> <span class="n" style="box-sizing: border-box;">tcprelay</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">init</span><span class="p" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">conf</span><span class="p" style="box-sizing: border-box;">)</span>
    <span class="n" style="box-sizing: border-box;">udp_server</span> <span class="o" style="box-sizing: border-box; color: #303030;">=</span> <span class="n" style="box-sizing: border-box;">udprelay</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">init</span><span class="p" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">conf</span><span class="p" style="box-sizing: border-box;">)</span>
    <span class="n" style="box-sizing: border-box;">dns_resolver</span> <span class="o" style="box-sizing: border-box; color: #303030;">=</span> <span class="n" style="box-sizing: border-box;">asyncdns</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">init</span><span class="p" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">conf</span><span class="p" style="box-sizing: border-box;">)</span>

    <span class="c1" style="box-sizing: border-box; color: grey;"># 将 TCPRelay、UDPRelay 和 DNSResolver 注册到事件循环中</span>
    <span class="n" style="box-sizing: border-box;">tcp_server</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">add_to_loop</span><span class="p" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">loop</span><span class="p" style="box-sizing: border-box;">)</span>
    <span class="n" style="box-sizing: border-box;">udp_server</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">add_to_loop</span><span class="p" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">loop</span><span class="p" style="box-sizing: border-box;">)</span>
    <span class="n" style="box-sizing: border-box;">dns_resolver</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">add_to_loop</span><span class="p" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">loop</span><span class="p" style="box-sizing: border-box;">)</span>

    <span class="n" style="box-sizing: border-box;">loop</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">run</span><span class="p" style="box-sizing: border-box;">()</span>

<span class="c1" style="box-sizing: border-box; color: grey;"># eventloop.py 中 loop.run 的实现</span>
<span class="k" style="box-sizing: border-box; color: green; font-weight: bold;">def</span> <span class="nf" style="box-sizing: border-box; color: #0060b0; font-weight: bold;">loop_run</span><span class="p" style="box-sizing: border-box;">():</span>
    <span class="k" style="box-sizing: border-box; color: green; font-weight: bold;">while</span> <span class="bp" style="box-sizing: border-box; color: #007020;">True</span><span class="p" style="box-sizing: border-box;">:</span>
        <span class="n" style="box-sizing: border-box;">events</span> <span class="o" style="box-sizing: border-box; color: #303030;">=</span> <span class="n" style="box-sizing: border-box;">wait_for_events</span><span class="p" style="box-sizing: border-box;">()</span>
        <span class="k" style="box-sizing: border-box; color: green; font-weight: bold;">for</span> <span class="n" style="box-sizing: border-box;">handler</span><span class="p" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;">event</span> <span class="ow" style="box-sizing: border-box; color: black; font-weight: bold;">in</span> <span class="n" style="box-sizing: border-box;">events</span><span class="p" style="box-sizing: border-box;">:</span>
            <span class="c1" style="box-sizing: border-box; color: grey;"># handler 是 TCPRelay、UDPRelay 或 DNSResolver</span>
            <span class="n" style="box-sizing: border-box;">handler</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">handle_event</span><span class="p" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">event</span><span class="p" style="box-sizing: border-box;">)</span>
</pre>
</div>
</td></tr>
</tbody></table>
<div style="box-sizing: border-box; margin-bottom: 16px;">
有一点需要提一下：<strong style="box-sizing: border-box; color: black;">代理和能翻墙的代理是不一样的</strong>。比如，下图是普通的 SOCKS5 代理：</div>
<div style="box-sizing: border-box; margin-bottom: 16px;">
<img alt="normal-proxy" src="https://cdn.loggerhead.me/images/normal-proxy.svg" style="border: 0px; box-sizing: content-box; max-width: 80%; vertical-align: middle;" /></div>
<div style="box-sizing: border-box; margin-bottom: 16px;">
而能翻墙的 SOCKS5 代理是下图这种结构：</div>
<div style="box-sizing: border-box; margin-bottom: 16px;">
<img alt="ss-proxy" src="https://cdn.loggerhead.me/images/ss-proxy.svg" style="border: 0px; box-sizing: content-box; max-width: 80%; vertical-align: middle;" /></div>
<div style="box-sizing: border-box; margin-bottom: 16px;">
可以看出来，SOCKS5 服务器的实现被拆分成了两部分：</div>
<ul style="box-sizing: border-box; margin-bottom: 16px; margin-top: 0px; padding: 0px 0px 0px 2em;">
<li style="box-sizing: border-box;">sslocal 负责与 SOCKS5 客户端进行 SOCKS5 协议相关的通讯（握手并建立连接），在建立连接后将 SOCKS5 客户端发来的数据加密并发送给 ssserver；</li>
<li style="box-sizing: border-box;">ssserver 起到一个中继的作用，负责解密以后将数据转发给目标服务器，并不涉及 SOCKS5 协议的任何一部分。</li>
</ul>
<div style="box-sizing: border-box; margin-bottom: 16px;">
其中一个重要的环节就是加密解密——数据经过 sslocal（本机）加密以后转发给 ssserver（VPS），这也是普通代理和能翻墙的代理的区别。在了解到这一点以后，shadowsocks 的很多细节就容易理解了。下面我们分模块，对 shadowsocks 内部结构一探究竟。</div>
<h1 id="_5" style="border-bottom: 1px solid rgb(238, 238, 238); box-sizing: border-box; color: inherit; font-family: inherit; font-size: 2.25em; line-height: 1.2; margin: 1em 0px 16px; padding-bottom: 0.3em;">
事件处理</h1>
<div style="box-sizing: border-box; margin-bottom: 16px;">
Shadowsocks 封装了三种常见的 IO 复用函数——<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">epoll</code>、<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">kqueue</code>&nbsp;和&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">select</code>，并通过&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">eventloop.py</code>&nbsp;提供统一的接口。之所以使用 IO 复用，而不是多线程的方式，是因为前者能提供更好的性能和更少的内存开销，这在路由器上至关重要<span id="fnref:router-problem" style="box-sizing: border-box; font-size: 12px; line-height: 0; position: relative; top: -0.5em; vertical-align: baseline;"><a class="footnote-ref" href="https://loggerhead.me/posts/shadowsocks-yuan-ma-fen-xi-xie-yi-yu-jie-gou.html#fn:router-problem" rel="footnote" style="background-color: transparent; box-sizing: border-box; color: #4078c0; text-decoration-line: none;">2</a></span>。</div>
<h2 id="eventlooppy" style="border-bottom: 1px solid rgb(238, 238, 238); box-sizing: border-box; color: inherit; font-family: inherit; font-size: 1.75em; line-height: 1.225; margin-bottom: 16px; margin-top: 1em; padding-bottom: 0.3em;">
eventloop.py</h2>
<div style="box-sizing: border-box; margin-bottom: 16px;">
<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">eventloop.py</code>&nbsp;的主要逻辑在于&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">run</code>&nbsp;函数的实现：</div>
<table class="highlighttable" style="background-color: inherit; border-collapse: collapse; border-radius: 3px; border-spacing: 0px; border: 1px solid rgb(204, 204, 204); box-sizing: border-box; display: block; margin-bottom: 16px; margin-top: 0px; overflow: auto; width: 848px; word-break: keep-all;"><tbody style="box-sizing: border-box;">
<tr style="background-color: inherit; border: 0px; box-sizing: border-box;"><td class="linenos" style="background-color: #f7f7f7; border-bottom-color: initial; border-bottom-style: initial; border-image: initial; border-left-color: initial; border-left-style: initial; border-right-color: rgb(221, 221, 221); border-right-style: solid; border-top-color: initial; border-top-style: initial; border-width: 0px 1px 0px 0px; box-sizing: border-box; margin: 0px; padding: 0px;"><div class="linenodiv" style="box-sizing: border-box;">
<pre style="background-color: inherit; border-radius: 3px; border: 0px; box-sizing: border-box; color: #aaaaaa; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: 1.45; overflow: initial; padding: 16px; word-break: break-all; word-wrap: normal;"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38</pre>
</div>
</td><td class="code" style="border: 0px; box-sizing: border-box; margin: 0px; padding: 0px; width: 799px;"><div class="highlight" style="border: 0px; box-sizing: border-box; margin: 0px;">
<pre style="background-color: inherit; border-radius: 3px; border: 0px; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: 1.45; overflow: initial; padding: 16px; word-break: normal; word-wrap: normal;"><span style="box-sizing: border-box;"></span><span class="k" style="box-sizing: border-box; color: green; font-weight: bold;">def</span> <span class="nf" style="box-sizing: border-box; color: #0060b0; font-weight: bold;">run</span><span class="p" style="box-sizing: border-box;">(</span><span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="p" style="box-sizing: border-box;">):</span>
    <span class="n" style="box-sizing: border-box;">events</span> <span class="o" style="box-sizing: border-box; color: #303030;">=</span> <span class="p" style="box-sizing: border-box;">[]</span>
    <span class="k" style="box-sizing: border-box; color: green; font-weight: bold;">while</span> <span class="ow" style="box-sizing: border-box; color: black; font-weight: bold;">not</span> <span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">_stopping</span><span class="p" style="box-sizing: border-box;">:</span>
        <span class="c1" style="box-sizing: border-box; color: grey;"># as soon as possible</span>
        <span class="n" style="box-sizing: border-box;">asap</span> <span class="o" style="box-sizing: border-box; color: #303030;">=</span> <span class="bp" style="box-sizing: border-box; color: #007020;">False</span>
        <span class="c1" style="box-sizing: border-box; color: grey;"># 获取事件</span>
        <span class="k" style="box-sizing: border-box; color: green; font-weight: bold;">try</span><span class="p" style="box-sizing: border-box;">:</span>
            <span class="n" style="box-sizing: border-box;">events</span> <span class="o" style="box-sizing: border-box; color: #303030;">=</span> <span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">poll</span><span class="p" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">TIMEOUT_PRECISION</span><span class="p" style="box-sizing: border-box;">)</span>
        <span class="k" style="box-sizing: border-box; color: green; font-weight: bold;">except</span> <span class="p" style="box-sizing: border-box;">(</span><span class="ne" style="box-sizing: border-box; color: #f00000; font-weight: bold;">OSError</span><span class="p" style="box-sizing: border-box;">,</span> <span class="ne" style="box-sizing: border-box; color: #f00000; font-weight: bold;">IOError</span><span class="p" style="box-sizing: border-box;">)</span> <span class="k" style="box-sizing: border-box; color: green; font-weight: bold;">as</span> <span class="n" style="box-sizing: border-box;">e</span><span class="p" style="box-sizing: border-box;">:</span>
            <span class="k" style="box-sizing: border-box; color: green; font-weight: bold;">if</span> <span class="n" style="box-sizing: border-box;">errno_from_exception</span><span class="p" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">e</span><span class="p" style="box-sizing: border-box;">)</span> <span class="ow" style="box-sizing: border-box; color: black; font-weight: bold;">in</span> <span class="p" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">errno</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">EPIPE</span><span class="p" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;">errno</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">EINTR</span><span class="p" style="box-sizing: border-box;">):</span>
                <span class="c1" style="box-sizing: border-box; color: grey;"># EPIPE: Happens when the client closes the connection</span>
                <span class="c1" style="box-sizing: border-box; color: grey;"># EINTR: Happens when received a signal</span>
                <span class="c1" style="box-sizing: border-box; color: grey;"># handles them as soon as possible</span>
                <span class="n" style="box-sizing: border-box;">asap</span> <span class="o" style="box-sizing: border-box; color: #303030;">=</span> <span class="bp" style="box-sizing: border-box; color: #007020;">True</span>
                <span class="n" style="box-sizing: border-box;">logging</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">debug</span><span class="p" style="box-sizing: border-box;">(</span><span class="s1" style="background-color: #fff0f0; box-sizing: border-box;">'poll:</span><span class="si" style="background-color: #e0e0e0; box-sizing: border-box;">%s</span><span class="s1" style="background-color: #fff0f0; box-sizing: border-box;">'</span><span class="p" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;">e</span><span class="p" style="box-sizing: border-box;">)</span>
            <span class="k" style="box-sizing: border-box; color: green; font-weight: bold;">else</span><span class="p" style="box-sizing: border-box;">:</span>
                <span class="n" style="box-sizing: border-box;">logging</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">error</span><span class="p" style="box-sizing: border-box;">(</span><span class="s1" style="background-color: #fff0f0; box-sizing: border-box;">'poll:</span><span class="si" style="background-color: #e0e0e0; box-sizing: border-box;">%s</span><span class="s1" style="background-color: #fff0f0; box-sizing: border-box;">'</span><span class="p" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;">e</span><span class="p" style="box-sizing: border-box;">)</span>
                <span class="kn" style="box-sizing: border-box; color: green; font-weight: bold;">import</span> <span class="nn" style="box-sizing: border-box; color: #0e84b5; font-weight: bold;">traceback</span>
                <span class="n" style="box-sizing: border-box;">traceback</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">print_exc</span><span class="p" style="box-sizing: border-box;">()</span>
                <span class="k" style="box-sizing: border-box; color: green; font-weight: bold;">continue</span>
        <span class="c1" style="box-sizing: border-box; color: grey;"># 找到事件对应的 handler，将事件交由它处理</span>
        <span class="k" style="box-sizing: border-box; color: green; font-weight: bold;">for</span> <span class="n" style="box-sizing: border-box;">sock</span><span class="p" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;">fd</span><span class="p" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;">event</span> <span class="ow" style="box-sizing: border-box; color: black; font-weight: bold;">in</span> <span class="n" style="box-sizing: border-box;">events</span><span class="p" style="box-sizing: border-box;">:</span>
            <span class="c1" style="box-sizing: border-box; color: grey;"># 通过 fd 找到对应的 handler</span>
            <span class="c1" style="box-sizing: border-box; color: grey;"># 一个 handler 可能对应多个 fd（reactor 模式）</span>
            <span class="n" style="box-sizing: border-box;">handler</span> <span class="o" style="box-sizing: border-box; color: #303030;">=</span> <span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">_fdmap</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">get</span><span class="p" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">fd</span><span class="p" style="box-sizing: border-box;">,</span> <span class="bp" style="box-sizing: border-box; color: #007020;">None</span><span class="p" style="box-sizing: border-box;">)</span>
            <span class="k" style="box-sizing: border-box; color: green; font-weight: bold;">if</span> <span class="n" style="box-sizing: border-box;">handler</span> <span class="ow" style="box-sizing: border-box; color: black; font-weight: bold;">is</span> <span class="ow" style="box-sizing: border-box; color: black; font-weight: bold;">not</span> <span class="bp" style="box-sizing: border-box; color: #007020;">None</span><span class="p" style="box-sizing: border-box;">:</span>
                <span class="n" style="box-sizing: border-box;">handler</span> <span class="o" style="box-sizing: border-box; color: #303030;">=</span> <span class="n" style="box-sizing: border-box;">handler</span><span class="p" style="box-sizing: border-box;">[</span><span class="mi" style="box-sizing: border-box; color: #0000d0; font-weight: bold;">1</span><span class="p" style="box-sizing: border-box;">]</span>
                <span class="k" style="box-sizing: border-box; color: green; font-weight: bold;">try</span><span class="p" style="box-sizing: border-box;">:</span>
                    <span class="c1" style="box-sizing: border-box; color: grey;"># handler 可能是 TCPRelay、UDPRelay 或 DNSResolver</span>
                    <span class="n" style="box-sizing: border-box;">handler</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">handle_event</span><span class="p" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">sock</span><span class="p" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;">fd</span><span class="p" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;">event</span><span class="p" style="box-sizing: border-box;">)</span>
                <span class="k" style="box-sizing: border-box; color: green; font-weight: bold;">except</span> <span class="p" style="box-sizing: border-box;">(</span><span class="ne" style="box-sizing: border-box; color: #f00000; font-weight: bold;">OSError</span><span class="p" style="box-sizing: border-box;">,</span> <span class="ne" style="box-sizing: border-box; color: #f00000; font-weight: bold;">IOError</span><span class="p" style="box-sizing: border-box;">)</span> <span class="k" style="box-sizing: border-box; color: green; font-weight: bold;">as</span> <span class="n" style="box-sizing: border-box;">e</span><span class="p" style="box-sizing: border-box;">:</span>
                    <span class="n" style="box-sizing: border-box;">shell</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">print_exception</span><span class="p" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">e</span><span class="p" style="box-sizing: border-box;">)</span>
        <span class="c1" style="box-sizing: border-box; color: grey;"># 计时器。每隔 10s 调用注册的 handle_periodic 函数</span>
        <span class="n" style="box-sizing: border-box;">now</span> <span class="o" style="box-sizing: border-box; color: #303030;">=</span> <span class="n" style="box-sizing: border-box;">time</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">time</span><span class="p" style="box-sizing: border-box;">()</span>
        <span class="k" style="box-sizing: border-box; color: green; font-weight: bold;">if</span> <span class="n" style="box-sizing: border-box;">asap</span> <span class="ow" style="box-sizing: border-box; color: black; font-weight: bold;">or</span> <span class="n" style="box-sizing: border-box;">now</span> <span class="o" style="box-sizing: border-box; color: #303030;">-</span> <span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">_last_time</span> <span class="o" style="box-sizing: border-box; color: #303030;">&gt;=</span> <span class="n" style="box-sizing: border-box;">TIMEOUT_PRECISION</span><span class="p" style="box-sizing: border-box;">:</span>
            <span class="k" style="box-sizing: border-box; color: green; font-weight: bold;">for</span> <span class="n" style="box-sizing: border-box;">callback</span> <span class="ow" style="box-sizing: border-box; color: black; font-weight: bold;">in</span> <span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">_periodic_callbacks</span><span class="p" style="box-sizing: border-box;">:</span>
                <span class="n" style="box-sizing: border-box;">callback</span><span class="p" style="box-sizing: border-box;">()</span>
            <span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">_last_time</span> <span class="o" style="box-sizing: border-box; color: #303030;">=</span> <span class="n" style="box-sizing: border-box;">now</span>
</pre>
</div>
</td></tr>
</tbody></table>
<div style="box-sizing: border-box; margin-bottom: 16px;">
<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">run</code>&nbsp;是一个典型的事件循环，它会阻塞在第 8 行等待注册事件的发生，然后通过事件对应的文件描述符&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">fd</code>&nbsp;找到&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">handler</code>，调用&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">handler.handle_event(sock, fd, event)</code>&nbsp;来将事件交由&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">handler</code>&nbsp;处理，同时每隔&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">TIMEOUT_PRECISION</code>&nbsp;秒调用&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">TCPRelay</code>、<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">UDPRelay</code>&nbsp;或&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">DNSResolver</code>&nbsp;的&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">handle_periodic</code>&nbsp;函数处理超时或清除缓存。</div>
<div style="box-sizing: border-box; margin-bottom: 16px;">
比如：如果客户端连接到 sslocal，第 8 行会返回可读事件，第 30 行会调用&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">TCPRelay</code>&nbsp;的&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">handle_event</code>&nbsp;来处理，<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">handle_event</code>&nbsp;发现这是一个可读事件，会调用&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">accept</code>&nbsp;建立新连接。</div>
<h2 id="tcprelaypy" style="border-bottom: 1px solid rgb(238, 238, 238); box-sizing: border-box; color: inherit; font-family: inherit; font-size: 1.75em; line-height: 1.225; margin-bottom: 16px; margin-top: 1em; padding-bottom: 0.3em;">
tcprelay.py</h2>
<div style="box-sizing: border-box; margin-bottom: 16px;">
Shadowsocks 采用了反应器模式（<a href="https://en.wikipedia.org/wiki/Reactor_pattern" style="background-color: transparent; box-sizing: border-box; color: #4078c0; text-decoration-line: none;">reactor pattern</a>），如下图所示。</div>
<div style="box-sizing: border-box; margin-bottom: 16px;">
<img alt="ss-reactor-pattern" src="https://cdn.loggerhead.me/images/ss-reactor-pattern.png" style="border: 0px; box-sizing: content-box; max-width: 80%; vertical-align: middle;" /></div>
<div style="box-sizing: border-box; margin-bottom: 16px;">
<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">TCPRelayHandler</code>&nbsp;的事件会由&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">EventLoop</code>&nbsp;分发给&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">TCPRelay</code>，再经由&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">TCPRelay</code>&nbsp;将事件分发给相应的&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">TCPRelayHandler</code>&nbsp;处理。这个过程发生在&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">EventLoop</code>&nbsp;和&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">TCPRelay</code>&nbsp;的&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">handle_event</code>&nbsp;函数。</div>
<div style="box-sizing: border-box; margin-bottom: 16px;">
我们去掉其中的日志处理和错误处理逻辑，看看&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">handle_event</code>&nbsp;函数：</div>
<table class="highlighttable" style="background-color: inherit; border-collapse: collapse; border-radius: 3px; border-spacing: 0px; border: 1px solid rgb(204, 204, 204); box-sizing: border-box; display: block; margin-bottom: 16px; margin-top: 0px; overflow: auto; width: 848px; word-break: keep-all;"><tbody style="box-sizing: border-box;">
<tr style="background-color: inherit; border: 0px; box-sizing: border-box;"><td class="linenos" style="background-color: #f7f7f7; border-bottom-color: initial; border-bottom-style: initial; border-image: initial; border-left-color: initial; border-left-style: initial; border-right-color: rgb(221, 221, 221); border-right-style: solid; border-top-color: initial; border-top-style: initial; border-width: 0px 1px 0px 0px; box-sizing: border-box; margin: 0px; padding: 0px;"><div class="linenodiv" style="box-sizing: border-box;">
<pre style="background-color: inherit; border-radius: 3px; border: 0px; box-sizing: border-box; color: #aaaaaa; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: 1.45; overflow: initial; padding: 16px; word-break: break-all; word-wrap: normal;"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre>
</div>
</td><td class="code" style="border: 0px; box-sizing: border-box; margin: 0px; padding: 0px; width: 799px;"><div class="highlight" style="border: 0px; box-sizing: border-box; margin: 0px;">
<pre style="background-color: inherit; border-radius: 3px; border: 0px; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: 1.45; overflow: initial; padding: 16px; word-break: normal; word-wrap: normal;"><span style="box-sizing: border-box;"></span><span class="k" style="box-sizing: border-box; color: green; font-weight: bold;">def</span> <span class="nf" style="box-sizing: border-box; color: #0060b0; font-weight: bold;">handle_event</span><span class="p" style="box-sizing: border-box;">(</span><span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="p" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;">sock</span><span class="p" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;">fd</span><span class="p" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;">event</span><span class="p" style="box-sizing: border-box;">):</span>
    <span class="c1" style="box-sizing: border-box; color: grey;"># 如果是 TCPRelay 的 socket</span>
    <span class="k" style="box-sizing: border-box; color: green; font-weight: bold;">if</span> <span class="n" style="box-sizing: border-box;">sock</span> <span class="o" style="box-sizing: border-box; color: #303030;">==</span> <span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">_server_socket</span><span class="p" style="box-sizing: border-box;">:</span>
        <span class="n" style="box-sizing: border-box;">conn</span> <span class="o" style="box-sizing: border-box; color: #303030;">=</span> <span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">_server_socket</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">accept</span><span class="p" style="box-sizing: border-box;">()</span>
        <span class="n" style="box-sizing: border-box;">TCPRelayHandler</span><span class="p" style="box-sizing: border-box;">(</span><span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="p" style="box-sizing: border-box;">,</span> <span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">_fd_to_handlers</span><span class="p" style="box-sizing: border-box;">,</span>
                        <span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">_eventloop</span><span class="p" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;">conn</span><span class="p" style="box-sizing: border-box;">[</span><span class="mi" style="box-sizing: border-box; color: #0000d0; font-weight: bold;">0</span><span class="p" style="box-sizing: border-box;">],</span> <span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">_config</span><span class="p" style="box-sizing: border-box;">,</span>
                        <span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">_dns_resolver</span><span class="p" style="box-sizing: border-box;">,</span> <span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">_is_local</span><span class="p" style="box-sizing: border-box;">)</span>
    <span class="k" style="box-sizing: border-box; color: green; font-weight: bold;">else</span><span class="p" style="box-sizing: border-box;">:</span>
        <span class="c1" style="box-sizing: border-box; color: grey;"># 找到 fd 对应的 TCPRelayHandler</span>
        <span class="n" style="box-sizing: border-box;">handler</span> <span class="o" style="box-sizing: border-box; color: #303030;">=</span> <span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">_fd_to_handlers</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">get</span><span class="p" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">fd</span><span class="p" style="box-sizing: border-box;">,</span> <span class="bp" style="box-sizing: border-box; color: #007020;">None</span><span class="p" style="box-sizing: border-box;">)</span>
        <span class="k" style="box-sizing: border-box; color: green; font-weight: bold;">if</span> <span class="n" style="box-sizing: border-box;">handler</span><span class="p" style="box-sizing: border-box;">:</span>
            <span class="n" style="box-sizing: border-box;">handler</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">handle_event</span><span class="p" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">sock</span><span class="p" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;">event</span><span class="p" style="box-sizing: border-box;">)</span>
</pre>
</div>
</td></tr>
</tbody></table>
<div style="box-sizing: border-box; margin-bottom: 16px;">
逻辑很简单，如果发生事件（可读事件）的 socket 是&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">TCPRelay</code>&nbsp;的 socket，说明有新的 TCP 连接，创建一个&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">TCPRelayHandler</code>&nbsp;对象将新连接封装起来。否则，找到发生事件的&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">TCPRelayHandler</code>，将事件交给它处理。</div>
<h2 id="udprelaypy" style="border-bottom: 1px solid rgb(238, 238, 238); box-sizing: border-box; color: inherit; font-family: inherit; font-size: 1.75em; line-height: 1.225; margin-bottom: 16px; margin-top: 1em; padding-bottom: 0.3em;">
udprelay.py</h2>
<div style="box-sizing: border-box; margin-bottom: 16px;">
<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">UDPRelay</code>&nbsp;的&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">handle_event</code>&nbsp;类似，不过它没有什么&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">UDPRelayHandler</code>，所有的逻辑都是&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">UDPRelay</code>&nbsp;处理的，只不过不同的 socket 对应不同的函数——<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">_handle_server</code>&nbsp;和&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">_handle_client</code>。</div>
<table class="highlighttable" style="background-color: inherit; border-collapse: collapse; border-radius: 3px; border-spacing: 0px; border: 1px solid rgb(204, 204, 204); box-sizing: border-box; display: block; margin-bottom: 16px; margin-top: 0px; overflow: auto; width: 848px; word-break: keep-all;"><tbody style="box-sizing: border-box;">
<tr style="background-color: inherit; border: 0px; box-sizing: border-box;"><td class="linenos" style="background-color: #f7f7f7; border-bottom-color: initial; border-bottom-style: initial; border-image: initial; border-left-color: initial; border-left-style: initial; border-right-color: rgb(221, 221, 221); border-right-style: solid; border-top-color: initial; border-top-style: initial; border-width: 0px 1px 0px 0px; box-sizing: border-box; margin: 0px; padding: 0px;"><div class="linenodiv" style="box-sizing: border-box;">
<pre style="background-color: inherit; border-radius: 3px; border: 0px; box-sizing: border-box; color: #aaaaaa; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: 1.45; overflow: initial; padding: 16px; word-break: break-all; word-wrap: normal;"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre>
</div>
</td><td class="code" style="border: 0px; box-sizing: border-box; margin: 0px; padding: 0px; width: 799px;"><div class="highlight" style="border: 0px; box-sizing: border-box; margin: 0px;">
<pre style="background-color: inherit; border-radius: 3px; border: 0px; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: 1.45; overflow: initial; padding: 16px; word-break: normal; word-wrap: normal;"><span style="box-sizing: border-box;"></span><span class="c1" style="box-sizing: border-box; color: grey;"># 只有可读事件，所以不需要传入 event 给 `_handle_server` 或 `_handle_client`</span>
<span class="k" style="box-sizing: border-box; color: green; font-weight: bold;">def</span> <span class="nf" style="box-sizing: border-box; color: #0060b0; font-weight: bold;">handle_event</span><span class="p" style="box-sizing: border-box;">(</span><span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="p" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;">sock</span><span class="p" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;">fd</span><span class="p" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;">event</span><span class="p" style="box-sizing: border-box;">):</span>
    <span class="k" style="box-sizing: border-box; color: green; font-weight: bold;">if</span> <span class="n" style="box-sizing: border-box;">sock</span> <span class="o" style="box-sizing: border-box; color: #303030;">==</span> <span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">_server_socket</span><span class="p" style="box-sizing: border-box;">:</span>
        <span class="c1" style="box-sizing: border-box; color: grey;"># 如果有错误发生，记录日志</span>
        <span class="k" style="box-sizing: border-box; color: green; font-weight: bold;">if</span> <span class="n" style="box-sizing: border-box;">event</span> <span class="o" style="box-sizing: border-box; color: #303030;">&amp;</span> <span class="n" style="box-sizing: border-box;">eventloop</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">POLL_ERR</span><span class="p" style="box-sizing: border-box;">:</span>
            <span class="n" style="box-sizing: border-box;">logging</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">error</span><span class="p" style="box-sizing: border-box;">(</span><span class="s1" style="background-color: #fff0f0; box-sizing: border-box;">'UDP server_socket err'</span><span class="p" style="box-sizing: border-box;">)</span>
        <span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">_handle_server</span><span class="p" style="box-sizing: border-box;">()</span>
    <span class="k" style="box-sizing: border-box; color: green; font-weight: bold;">elif</span> <span class="n" style="box-sizing: border-box;">sock</span> <span class="ow" style="box-sizing: border-box; color: black; font-weight: bold;">and</span> <span class="p" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">fd</span> <span class="ow" style="box-sizing: border-box; color: black; font-weight: bold;">in</span> <span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">_sockets</span><span class="p" style="box-sizing: border-box;">):</span>
        <span class="k" style="box-sizing: border-box; color: green; font-weight: bold;">if</span> <span class="n" style="box-sizing: border-box;">event</span> <span class="o" style="box-sizing: border-box; color: #303030;">&amp;</span> <span class="n" style="box-sizing: border-box;">eventloop</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">POLL_ERR</span><span class="p" style="box-sizing: border-box;">:</span>
            <span class="n" style="box-sizing: border-box;">logging</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">error</span><span class="p" style="box-sizing: border-box;">(</span><span class="s1" style="background-color: #fff0f0; box-sizing: border-box;">'UDP client_socket err'</span><span class="p" style="box-sizing: border-box;">)</span>
        <span class="c1" style="box-sizing: border-box; color: grey;"># 需要告诉是哪个 sock 发生了事件</span>
        <span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">_handle_client</span><span class="p" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">sock</span><span class="p" style="box-sizing: border-box;">)</span>
</pre>
</div>
</td></tr>
</tbody></table>
<h2 id="asyncdnspy" style="border-bottom: 1px solid rgb(238, 238, 238); box-sizing: border-box; color: inherit; font-family: inherit; font-size: 1.75em; line-height: 1.225; margin-bottom: 16px; margin-top: 1em; padding-bottom: 0.3em;">
asyncdns.py</h2>
<div style="box-sizing: border-box; margin-bottom: 16px;">
<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">DNSResolver</code>&nbsp;的&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">handle_event</code>&nbsp;与&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">TCPRelay</code>&nbsp;和&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">UDPRelay</code>&nbsp;都不一样，因为它不需要分发处理，所以逻辑更简单：</div>
<table class="highlighttable" style="background-color: inherit; border-collapse: collapse; border-radius: 3px; border-spacing: 0px; border: 1px solid rgb(204, 204, 204); box-sizing: border-box; display: block; margin-bottom: 16px; margin-top: 0px; overflow: auto; width: 848px; word-break: keep-all;"><tbody style="box-sizing: border-box;">
<tr style="background-color: inherit; border: 0px; box-sizing: border-box;"><td class="linenos" style="background-color: #f7f7f7; border-bottom-color: initial; border-bottom-style: initial; border-image: initial; border-left-color: initial; border-left-style: initial; border-right-color: rgb(221, 221, 221); border-right-style: solid; border-top-color: initial; border-top-style: initial; border-width: 0px 1px 0px 0px; box-sizing: border-box; margin: 0px; padding: 0px;"><div class="linenodiv" style="box-sizing: border-box;">
<pre style="background-color: inherit; border-radius: 3px; border: 0px; box-sizing: border-box; color: #aaaaaa; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: 1.45; overflow: initial; padding: 16px; word-break: break-all; word-wrap: normal;"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre>
</div>
</td><td class="code" style="border: 0px; box-sizing: border-box; margin: 0px; padding: 0px; width: 799px;"><div class="highlight" style="border: 0px; box-sizing: border-box; margin: 0px;">
<pre style="background-color: inherit; border-radius: 3px; border: 0px; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: 1.45; overflow: initial; padding: 16px; word-break: normal; word-wrap: normal;"><span style="box-sizing: border-box;"></span><span class="c1" style="box-sizing: border-box; color: grey;"># 只有可读事件</span>
<span class="k" style="box-sizing: border-box; color: green; font-weight: bold;">def</span> <span class="nf" style="box-sizing: border-box; color: #0060b0; font-weight: bold;">handle_event</span><span class="p" style="box-sizing: border-box;">(</span><span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="p" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;">sock</span><span class="p" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;">fd</span><span class="p" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;">event</span><span class="p" style="box-sizing: border-box;">):</span>
    <span class="c1" style="box-sizing: border-box; color: grey;"># 防御性编程，实际上是个无用的判断</span>
    <span class="k" style="box-sizing: border-box; color: green; font-weight: bold;">if</span> <span class="n" style="box-sizing: border-box;">sock</span> <span class="o" style="box-sizing: border-box; color: #303030;">!=</span> <span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">_sock</span><span class="p" style="box-sizing: border-box;">:</span>
        <span class="k" style="box-sizing: border-box; color: green; font-weight: bold;">return</span>
    <span class="c1" style="box-sizing: border-box; color: grey;"># 如果有错误事件发生</span>
    <span class="k" style="box-sizing: border-box; color: green; font-weight: bold;">if</span> <span class="n" style="box-sizing: border-box;">event</span> <span class="o" style="box-sizing: border-box; color: #303030;">&amp;</span> <span class="n" style="box-sizing: border-box;">eventloop</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">POLL_ERR</span><span class="p" style="box-sizing: border-box;">:</span>
        <span class="n" style="box-sizing: border-box;">logging</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">error</span><span class="p" style="box-sizing: border-box;">(</span><span class="s1" style="background-color: #fff0f0; box-sizing: border-box;">'dns socket err'</span><span class="p" style="box-sizing: border-box;">)</span>
        <span class="c1" style="box-sizing: border-box; color: grey;"># 从事件循环移除 self._sock</span>
        <span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">_loop</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">remove</span><span class="p" style="box-sizing: border-box;">(</span><span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">_sock</span><span class="p" style="box-sizing: border-box;">)</span>
        <span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">_sock</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">close</span><span class="p" style="box-sizing: border-box;">()</span>
        <span class="c1" style="box-sizing: border-box; color: grey;"># 重新初始化 self._sock</span>
        <span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">_sock</span> <span class="o" style="box-sizing: border-box; color: #303030;">=</span> <span class="n" style="box-sizing: border-box;">socket</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">socket</span><span class="p" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">socket</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">AF_INET</span><span class="p" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;">socket</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">SOCK_DGRAM</span><span class="p" style="box-sizing: border-box;">,</span>
                                   <span class="n" style="box-sizing: border-box;">socket</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">SOL_UDP</span><span class="p" style="box-sizing: border-box;">)</span>
        <span class="c1" style="box-sizing: border-box; color: grey;"># 将套接字设置为非阻塞模式</span>
        <span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">_sock</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">setblocking</span><span class="p" style="box-sizing: border-box;">(</span><span class="bp" style="box-sizing: border-box; color: #007020;">False</span><span class="p" style="box-sizing: border-box;">)</span>
        <span class="c1" style="box-sizing: border-box; color: grey;"># 重新注册到事件循环</span>
        <span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">_loop</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">add</span><span class="p" style="box-sizing: border-box;">(</span><span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">_sock</span><span class="p" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;">eventloop</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">POLL_IN</span><span class="p" style="box-sizing: border-box;">,</span> <span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="p" style="box-sizing: border-box;">)</span>
    <span class="k" style="box-sizing: border-box; color: green; font-weight: bold;">else</span><span class="p" style="box-sizing: border-box;">:</span>
        <span class="c1" style="box-sizing: border-box; color: grey;"># 读取一个 UDP 包，并取出前 1024 个字节</span>
        <span class="c1" style="box-sizing: border-box; color: grey;"># 注意：如果一个 UDP 包超过 1024 字节，比如：2048 字节。</span>
        <span class="c1" style="box-sizing: border-box; color: grey;"># 一次 recvfrom(1024) 也会消耗整个 UDP 包。这里是认为</span>
        <span class="c1" style="box-sizing: border-box; color: grey;"># DNS 查询返回的 UDP 包都不会超过 1024 字节。</span>
        <span class="n" style="box-sizing: border-box;">data</span><span class="p" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;">addr</span> <span class="o" style="box-sizing: border-box; color: #303030;">=</span> <span class="n" style="box-sizing: border-box;">sock</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">recvfrom</span><span class="p" style="box-sizing: border-box;">(</span><span class="mi" style="box-sizing: border-box; color: #0000d0; font-weight: bold;">1024</span><span class="p" style="box-sizing: border-box;">)</span>
        <span class="k" style="box-sizing: border-box; color: green; font-weight: bold;">if</span> <span class="n" style="box-sizing: border-box;">addr</span><span class="p" style="box-sizing: border-box;">[</span><span class="mi" style="box-sizing: border-box; color: #0000d0; font-weight: bold;">0</span><span class="p" style="box-sizing: border-box;">]</span> <span class="ow" style="box-sizing: border-box; color: black; font-weight: bold;">not</span> <span class="ow" style="box-sizing: border-box; color: black; font-weight: bold;">in</span> <span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">_servers</span><span class="p" style="box-sizing: border-box;">:</span>
            <span class="n" style="box-sizing: border-box;">logging</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">warn</span><span class="p" style="box-sizing: border-box;">(</span><span class="s1" style="background-color: #fff0f0; box-sizing: border-box;">'received a packet other than our dns'</span><span class="p" style="box-sizing: border-box;">)</span>
            <span class="k" style="box-sizing: border-box; color: green; font-weight: bold;">return</span>
        <span class="bp" style="box-sizing: border-box; color: #007020;">self</span><span class="o" style="box-sizing: border-box; color: #303030;">.</span><span class="n" style="box-sizing: border-box;">_handle_data</span><span class="p" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">data</span><span class="p" style="box-sizing: border-box;">)</span>
</pre>
</div>
</td></tr>
</tbody></table>
<h1 id="_6" style="border-bottom: 1px solid rgb(238, 238, 238); box-sizing: border-box; color: inherit; font-family: inherit; font-size: 2.25em; line-height: 1.2; margin: 1em 0px 16px; padding-bottom: 0.3em;">
总结</h1>
<div style="box-sizing: border-box; margin-bottom: 16px;">
本来想一篇写完的……没想到才简单的介绍一下就这么长了，之后再分两篇写&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">tcprelay.py</code>&nbsp;和&nbsp;<code style="background-color: rgba(0, 0, 0, 0.04); border-radius: 3px; box-sizing: border-box; color: #c7254e; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 13.6px; margin: 0px; padding: 0.2em 0px;">udprelay.py</code>&nbsp;的细节好了。</div>
<div class="footnote" style="box-sizing: border-box; font-size: 0.9em; margin-bottom: 40px;">
<hr style="background: rgb(170, 170, 170); border: 0px none; box-sizing: content-box; height: 1px; margin: 20px 0px; padding: 0px;" />
<ol style="box-sizing: border-box; margin-bottom: 16px; margin-top: 0px; padding: 0px 0px 0px 2em;">
<li id="fn:bnd.addr" style="box-sizing: border-box;"><div style="box-sizing: border-box; margin-bottom: 16px; margin-top: 16px;">
也有部分 SOCKS5 服务器的实现返回全零。&nbsp;<a class="footnote-backref" href="https://loggerhead.me/posts/shadowsocks-yuan-ma-fen-xi-xie-yi-yu-jie-gou.html#fnref:bnd.addr" rev="footnote" style="background-color: transparent; box-sizing: border-box; color: #4078c0; font-family: sans-serif; text-decoration-line: none;" title="Jump back to footnote 1 in the text">↩</a></div>
</li>
<li id="fn:router-problem" style="box-sizing: border-box;"><div style="box-sizing: border-box; margin-bottom: 16px; margin-top: 16px;">
因为路由器的 CPU 性能远不如 PC，内存也很少，可能只有几十 MB 可以用。&nbsp;<a class="footnote-backref" href="https://loggerhead.me/posts/shadowsocks-yuan-ma-fen-xi-xie-yi-yu-jie-gou.html#fnref:router-problem" rev="footnote" style="background-color: transparent; box-sizing: border-box; color: #4078c0; font-family: sans-serif; text-decoration-line: none;" title="Jump back to footnote 2 in the text">↩</a></div>
</li>
</ol>
</div>
</div>
