<h2 style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 2.15em; font-weight: 100; line-height: 1.1; margin: 0.8em 0px; padding: 0px;">
三、异步client与异步server的通信</h2>
<h3 style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 1.7em; font-weight: 100; line-height: 1.1; margin: 0.8em 0px; padding: 0px;">
<a href="https://www.blogger.com/null" name="t1" style="background: transparent; box-sizing: border-box; color: #4fa1db; margin: 0px; outline: 0px; padding: 0px;"></a>1. 服务端代码</h3>
<span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">pythone socket的server段,开放三个端口:10000,10001,10002.</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">例子中是每个server绑定一个端口,测试的时候需要分别开3个shell,分别运行.</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">这太麻烦了,就分别用三个Thread来运行这些services</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">#!/usr/bin/env python</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">#</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;"># -*- coding:utf-8 -*-</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;"># File: multithrd_socket_server.py</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">#</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">import optparse</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">import os</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">import socket</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">import time</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">from threading import Thread</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">from io import StringIO</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">txt = '''1111</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">​</span><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">2222</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">3333</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">4444</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">'''</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;"># 服务端程序处理过程</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">def server(listen_socket):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; while True:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; buf = StringIO(txt)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; sock, addr = listen_socket.accept()</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; print('Somebody at %s wants poetry!' %(addr,))</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; while True:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; try:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">line = buf.readline().strip()</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">if not line:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">sock.close()</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">break</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">sock.sendall(line.encode('utf8')) # this is a blocking call</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">print('send bytes to client: %s' %line)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; except socket.error:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sock.close()</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; time.sleep(0.5) # server每发送一个单词后等待一会</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; sock.close()</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; print('\n')</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;"># 同时开启三个服务端线程，分别在三个端口监听</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;"># 服务端程序为阻塞方式，只能一次服务于一个客户端</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">def main():</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp;&nbsp;</span><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp;&nbsp;ports = [10000, 10001, 10002]</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; for port in ports:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; listen_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; listen_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; addres = ('127.0.0.1', port)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; listen_socket.bind(addres)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; listen_socket.listen(5)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; print("start listen at: %d" %port)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; worker = Thread(target = server, args = [listen_socket])</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; worker.setDaemon(True)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; worker.start()</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">​</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">if __name__ == '__main__':</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; main()</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; while True:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; time.sleep(0.1) # 如果不sleep的话, CPU会被Python完全占用了</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">​</span><br />
<h3 style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 1.7em; font-weight: 100; line-height: 1.1; margin: 0.8em 0px; padding: 0px;">
<a href="https://www.blogger.com/null" name="t2" style="background: transparent; box-sizing: border-box; color: #4fa1db; margin: 0px; outline: 0px; padding: 0px;"></a>2. 同步客户端&nbsp;</h3>
<span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">下面是一个client, 用阻塞方式，先后连接这个三个端口的server:&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">from socket import *</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;"># 建立三个客户端，分别连接三个不同的服务端程序, 接收服务端传过来的数据并打印</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;"># 这三个客户端是阻塞方式通信的</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">if __name__ == '__main__':</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; ports = [10000, 10001, 10002]</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; for port in ports:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; address = ('127.0.0.1', port)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; sock = socket(AF_INET, SOCK_STREAM)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; sock.connect(address)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; poem = ''</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">​</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; while True:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; data = sock.recv(4)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if not data:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sock.close()</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; poem += data.decode('utf8')</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; print(poem)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; sock.close()</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br />
<h3 style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 1.7em; font-weight: 100; line-height: 1.1; margin: 0.8em 0px; padding: 0px;">
<a href="https://www.blogger.com/null" name="t3" style="background: transparent; box-sizing: border-box; color: #4fa1db; margin: 0px; outline: 0px; padding: 0px;"></a>3. 异步客户端:</h3>
<span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">import datetime, errno, optparse, select, socket</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">def connect(port):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; """Connect to the given server and return a non-blocking socket."""</span><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp;&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; address = ('127.0.0.1', port)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; sock.connect(address)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; sock.setblocking(0) # 设置为非阻塞模式</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; return sock</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">​</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">def format_address(address):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; host, port = address</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; return '%s:%s' % (host or '127.0.0.1', port)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">if __name__ == '__main__':</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; ports = [10000, 10001, 10002]</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; start = datetime.datetime.now()</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; sockets = list(map(connect, ports))</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; poems = dict.fromkeys(sockets, '') # socket -&gt; accumulated poem</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; sock2task = dict([(s, i + 1) for i, s in enumerate(sockets)])</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; while sockets:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; #运用select来确保那些可读取的异步socket可以立即开始读取IO</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; #OS不停的搜索目前可以read的socket，有的话就返回rlist</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; rlist, _, _ = select.select(sockets, [], [])</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; for sock in rlist:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; data = ''</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; while True:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; try:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; new_data = sock.recv(1024)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; new_data = new_data.decode('utf8')</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; except socket.error as e:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if e.args[0] == errno.EWOULDBLOCK:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; raise</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if not new_data:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; print(new_data)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; data += new_data</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; task_num = sock2task[sock]</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if not data:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; print(poems[sock]) # 打印sock接收到的数据</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sockets.remove(sock)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sock.close()</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; print('Task %d finished\n' % task_num)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addr_fmt = format_address(sock.getpeername())</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; msg = 'Task %d: got %d bytes of poetry from %s\n'</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; print(msg % (task_num, len(data), addr_fmt))</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; poems[sock] += data # 保存每个sock接收到的数据</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">​</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; elapsed = datetime.datetime.now() - start</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; print('Got poems in %s' %elapsed)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">对客户端的异步改造主要有两点：&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">同步模式下，客户端分别创建socket；</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">而在异步模式下，client开始就创建了所有的socket。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">通过“sock.setblocking(0)”设置socket为异步模式。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">通过Unix系统的select来返回可读取socket信息</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">最为核心的是8行和26行。尤其是26行的select操作返回待读取socket的列表&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br />
<h2 style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 2.15em; font-weight: 100; line-height: 1.1; margin: 0.8em 0px; padding: 0px;">
<a href="https://www.blogger.com/null" name="t4" style="background: transparent; box-sizing: border-box; color: #4fa1db; margin: 0px; outline: 0px; padding: 0px;"></a>四、asyncore实现异步socket通信</h2>
<span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">该模块提供了异步socket服务客户端和服务器的基础架构。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">只有两种方法让程序在单个处理器上的同时做超过一件的事情。&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">多线程编程是最简单，最普遍的方式，</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">但还有另一种非常不同的技术，可以让你具有多线程几乎所有的优点，实际上并没有使用多线程。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">程序的瓶颈主要在于I/O时是比较可行的。如果你的程序的瓶颈在处理器，确实需要多线程，不过网络服务器的瓶颈大多在I/O。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">如果您的操作系统支持I/O库的select()系统调用（一般都支持） ，</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">那么你可以使用它同时处理多个通信信道，做其他的工作的同时让I/O在后台执行，这比多线程更容易理解。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">asyncore和asynchat的基本思路是创建一个或多个网络通道，即asyncore.dispatcher和asynchat.async_chat的实例。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">然后添加到全局映射，如果你没有创建自己的映射，可以直接使用loop()函数。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">loop()激活所有通道服务，执行直到最后一个通道关闭。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br />
<h3 style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 1.7em; font-weight: 100; line-height: 1.1; margin: 0.8em 0px; padding: 0px;">
<a href="https://www.blogger.com/null" name="t5" style="background: transparent; box-sizing: border-box; color: #4fa1db; margin: 0px; outline: 0px; padding: 0px;"></a>4.1 接口文档</h3>
<span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">1. asyncore.loop([timeout[, use_poll[, map[, count]]]])</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; 进入轮询循环直到所有打开的通道已被关闭或计数通过。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; 所有的参数都是可选的。 count参数默认为None，只有当所有通道都被关闭时循环才会终止。&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; timeout参数设置为select()或poll()调用设置超时，以秒为单位，默认为30秒。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; use_poll参数，如果为true ，则表示 poll()优先于select()，默认值为False。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; map是包含监控的channel的字典。channel关闭时会从map中删除。不指定map时会使用全局map。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; Channel(asyncore.dispatcher ， asynchat.async_chat和其子类的实例）可以自由地混合在map上)。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">2. class asyncore.dispatcher：&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; dispatcher底层socket的轻便包装。它有一些事件处理供异步循环调用。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; 否则，它可以被视为一个正常的非阻塞socket对象。底层事件的触发或者连接状态改变通知异步循环发生了高层事件，</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; 高层事件有：</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; . handle_connect()：Implied by the first read or write event。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; . handle_close()：Implied by a read event with no data available。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; . handle_accept()：Implied by a read event on a listening socket。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">3. asyncore.dispatcher的新方法：</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; 在异步处理，每个映射通道的readable()和writable()方法用于确定通道的socket</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; 是否应该被添加到select()或poll()通道的频道列表中以读写事件。因此通道事件比基本socket 事件要多。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; 在子类中重写的方法如下：</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; . handle_read()：当异步循环检测到通道的read()将成功时调用。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; . handle_write()：当异步循环检测到通道的write()将成功时调用。需要缓冲以提高性能。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;def handle_write(self):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sent = self.send(self.buffer)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.buffer = self.buffer[sent:]</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; . handle_expt()：</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; 当有socket连接有带外数据【 out of band (OOB)】时调用。这几乎不会发生，因为OOB的支持很好且很少使用。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; . handle_connect()：</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; 当活动socket实际创建连接时调用。可能发送“welcome” banner，或与远程端点启动协议协商。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; . handle_close()：</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; 当关闭socket时调用。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; . handle_error()：</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; 当异常引发又没有其他处理时调用。默认版本print压缩的traceback。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; . handle_accept()：</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; 监听通道(被动开启) ，当本端通过connect()可以和远端建立连接时在监听通道(被动开启)上调用。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">4. readable()：</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; 每次异步循环时调用，以确定通道的socket是否应该被添加到产生读事件列表。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; 默认的方法只返回True，表示在默认情况下，所有通道将拥有读取事件。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">5. writable()：每次异步循环时调用，以确定通道的socket是否应该被添加到产生写事件列表。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; 默认的方法只返回True，表示在默认情况下，所有通道将拥有写事件。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">6. 下面方法和socket相同，有些有所扩充：</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">. create_socket(family, type)：参见socket文档。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">. connect(address)：参见socket文档。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">. send(data)：发送数据到远端socket。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">. recv(buffer_size)：从远端socket最多接收buffer_size字节的数据。空字符串意味着该信道已被远端关闭。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">. listen(backlog)：监听的连接数，默认和最小值都为1，最大值根据系统确定，一般是5。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">. bind(address)：绑定socket到address。socket必须未绑定。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; 地址的格式取决于地址族 ，参见socket文档。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; 调用set_reuse_addr()方法可以把socket设置为可重用的(参见设置SO_REUSEADDR选项)。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">. accept()：接受连接。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; socket必须绑定到地址和监听连接。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; 返回值可以是None 或一对(conn, address)，其中conn是新的可用来在连接上发送和接收数据socket对象，</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; address 是绑定到连接上远端套接字的地址。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; None意味着连接并没有发生，在这种情况下，服务器应该忽略并继续侦听其他连接。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">. close()：关闭套接字。&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; Socket对象上的所有未来的操作将失败。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; 远端将接收没有更多的数据（排队数据清空之后） 。socket也会被垃圾收集自动关闭。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">7. asyncore.dispatcher_with_send：</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;dispatcher的子类，增加了简单的缓冲输出，对于简单的客户端有用。详细资料参考：asynchat.async_chat。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">8. class asyncore.file_dispatcher：</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;封装了文件描述符或文件对象及映射参数(可选)供poll()和loop()函数使用的文件分发器。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;它提供了文件对象或其他具备fileno()方法的对象，调用fileno()并传递到file_wrapper构造函数。可用于UNIX。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">9. class asyncore.file_wrapper：</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;接收整数文件描述符并调用os.dup()复制句柄，这样原句柄可以关闭，而文件包装器不受影响。</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;该类封装了大量方法以模拟socket给file_dispatcher类使用。可用于UNIX。</span><br />
<h3 style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 1.7em; font-weight: 100; line-height: 1.1; margin: 0.8em 0px; padding: 0px;">
<a href="https://www.blogger.com/null" name="t6" style="background: transparent; box-sizing: border-box; color: #4fa1db; margin: 0px; outline: 0px; padding: 0px;"></a>4.2. 示例1</h3>
<h4 style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; font-weight: 100; line-height: 24px; margin: 0.8em 0px; padding: 0px;">
1. 服务端程序&nbsp;</h4>
<span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">#!/usr/bin/env python</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;"># -*- coding: utf-8 -*-</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;"># File: asyncore_server.py</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">#</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">import socket</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">import asyncore</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">import threading</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">​</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">MAX_RECV = 4096</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">#負責接受client socket連線</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">class AgentServer(asyncore.dispatcher): &nbsp;&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;def __init__(self, port):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;#asyncore.dispatcher的constructor</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;asyncore.dispatcher.__init__(self)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;#client socket</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;self.clientSocket = None</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;#server port</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;self.port = port</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;#建立等待的socket</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;self.create_socket(socket.AF_INET, socket.SOCK_STREAM)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;self.bind(('', self.port))</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;self.listen(5)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp;&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;def handle_accept(self):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;#接受client socket的連線</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;self.clientSocket, address = self.accept()</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;print 'New client from : ' + address[0]</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;#將和client連線的socket加上一些功能 (自訂socket)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;self.clientSocket = ClientAgent(self.clientSocket)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">#自訂的client連線socket</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">class ClientAgent(asyncore.dispatcher):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;def __init__(self, socket):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;asyncore.dispatcher.__init__(self, socket)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;#要送出的data</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;self.SendData = ""</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;#從client收到的data</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;def handle_read(self):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;self.RecvData = self.recv(MAX_RECV)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;if len(self.RecvData) &gt; 0:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print "recv : " + self.RecvData</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;#送出data到client</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;def handle_write(self):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;send_byte = self.send(self.SendData)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;#一次可能不會全部送完(一次最多送出512 bytes ?)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;if send_byte &gt; 0:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;send_out = self.SendData[:send_byte]</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.SendData = self.SendData[send_byte:]</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.handle_write()</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;else:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print "send all!!"</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.SendData = ""</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;#不自動執行handle_write</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;def writable(self):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;return False</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp;&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;def handle_close(self):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;print "close connection : " + self.getpeername()[0]</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;self.close()</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">#產生等待client連線的thread</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">class listen_client_thread(threading.Thread):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;def __init__(self,port):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;self.agentServer = AgentServer(port)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;threading.Thread.__init__ ( self )</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp;&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;def run(self):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;print "Listen Client ..."</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;asyncore.loop()</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">#產生處理輸入的thread &nbsp; &nbsp; &nbsp;&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">class input_thread(threading.Thread):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;def __init__(self,listen_thread):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;self.listen_thread = listen_thread</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;threading.Thread.__init__ ( self )</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;def run(self):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;while 1:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;send_data = raw_input()</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.listen_thread.agentServer.clientSocket.SendData = send_data</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.listen_thread.agentServer.clientSocket.handle_write()</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">if __name__ == "__main__":</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;#產生等待client連線的thread</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;listen_thread = listen_client_thread(111)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;listen_thread.start()</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;#產生處理輸入的thread</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;input_thread(listen_thread).start()</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br />
<h4 style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; font-weight: 100; line-height: 24px; margin: 0.8em 0px; padding: 0px;">
2. Client 程式 :</h4>
<span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">#!/usr/bin/env python</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;"># -*- coding: utf-8 -*-</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;"># File: asyncore_client.py</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">#</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">import asyncore, socket</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">import threading</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">#收到data最大長度</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">MAX_RECV = 4096</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">#連線server的socket</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">class client(asyncore.dispatcher):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;def __init__(self, host, port):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;asyncore.dispatcher.__init__(self)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;self.SendData = ""</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;self.RecvData = ""</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;#和server建立連線</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;self.create_socket(socket.AF_INET, socket.SOCK_STREAM)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;self.connect( (host, port) )</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;def handle_connect(self):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;print 'connect!!'</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;def handle_close(self):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;print "disconnection : " + self.getpeername()[0]</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;self.close()</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;#收到的data</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;def handle_read(self):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;self.RecvData = self.recv(MAX_RECV)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;if len(self.RecvData) &gt; 0:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print "recv : " + self.RecvData</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;#送出data</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;def handle_write(self):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;send_byte = self.send(self.SendData)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;if send_byte &gt; 0:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;send_out = self.SendData[:send_byte]</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.SendData = self.SendData[send_byte:]</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print "send : " + send_out</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.handle_write()</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;else:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print "send all!!"</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.SendData = ""</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;#自動偵測送出永遠失敗</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;def writable(self):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;return False</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">#等待server傳送訊息的thread</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">class send_server_thread(threading.Thread):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;def __init__(self,host,port):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;self.client = client(host, port)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;threading.Thread.__init__ ( self )</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;def run(self):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;try:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;asyncore.loop()</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;except:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pass</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">#等待user input的thread &nbsp; &nbsp; &nbsp;&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">class input_thread(threading.Thread):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;def __init__(self,client_thread):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;self.client_thread = client_thread</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;threading.Thread.__init__ ( self )</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;def run(self):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp;while 1:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;send_data = raw_input()</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.client_thread.client.SendData = send_data</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.client_thread.client.handle_write()</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">#主程式</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">if __name__ == "__main__":</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;#建立和server連線, 並且等待溝通</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;client_thread = send_server_thread("localhost",111)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;client_thread.start()</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;#等待user input</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp;input_thread(client_thread).start()</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br />
<h3 style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 1.7em; font-weight: 100; line-height: 1.1; margin: 0.8em 0px; padding: 0px;">
<a href="https://www.blogger.com/null" name="t7" style="background: transparent; box-sizing: border-box; color: #4fa1db; margin: 0px; outline: 0px; padding: 0px;"></a>4.3 示例2</h3>
<span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">The Python asyncore and aynchat modules</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">The Python standard library provides two modules—asyncore and</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">asynchat—to help in writing concurrent network servers using</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">event-based designs. The documentation does not give good examples,</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">so I am making some notes.</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br />
<h4 style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; font-weight: 100; line-height: 24px; margin: 0.8em 0px; padding: 0px;">
1. Overview</h4>
<span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">The basic idea behind the asyncore module is that:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">. there is a function, asyncore.loop() that does select() on a bunch of ‘channels’.&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; Channels are thin wrappers around sockets.</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">. when select returns, it reports which sockets have data waiting to be read,</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; which ones are now free to send more data, and which ones have errors;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; loop() examines the event and the socket’s state to create a higher level event;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">. it then calls a method on the channel corresponding to the higher level event.</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">asyncore provides a low-level, but flexible API to build network</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">servers. asynchat builds upon asyncore and provides an API that is</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">more suitable for request/response type of protocols.</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br />
<h4 style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; font-weight: 100; line-height: 24px; margin: 0.8em 0px; padding: 0px;">
2. aysncore</h4>
<span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">The asyncore module’s API consists of:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">. the loop() method, to be called by a driver program written by you;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">. the dispatcher class, to be subclassed by you to do useful stuff.&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; The dispatcher class is what is called ‘channel’ elsewhere.</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">+-------------+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +--------+</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">| driver code |---------&gt; | loop() |</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">+-------------+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +--------+</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| loop-dispatcher API (a)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+--------------+</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| dispatcher &nbsp; |</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; +-----------------&gt;| subclass &nbsp; &nbsp; |</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+--------------+</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| dispatcher-logic API (b)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+--------------+</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| server logic |</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+--------------+</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">This is all packaged nicely in an object oriented way. So, we have</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">the dispatcher class, that extends/wraps around the socket class (from</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">the socket module in the Python standard library). It provides all</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">the socket class’ methods, as well as methods to handle the higher</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">level events. You are supposed to subclass dispatcher and implement</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">the event handling methods to do something useful.</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br />
<h4 style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; font-weight: 100; line-height: 24px; margin: 0.8em 0px; padding: 0px;">
3. The loop-dispatcher API</h4>
<span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">The loop function looks like this:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; loop( [timeout[, use_poll[, map[,count]]]])</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">What is the map? It is a dictionary whose keys are the</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">file-descriptors, or fds, of the socket (i.e., socket.fileno()), and</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">whose values are the dispatcher objects which you want to handle events on that socket/fd.</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">When we create a new dispatcher object, it automatically gets added to a</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">global list of sockets (which is invisible to us, and managed behind the scenes).</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">The loop() function does a select() on this&nbsp;</span><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">list.</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">We can over-ride the list that loop looks at, by providing an explicit map.&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">But then, we would need to add/remove dispatchers we create to/from this map ourselves.&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">(Hmm… we might always wantto use explicit maps; then our loop calls will be thread safe and we</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">will be able to launch multiple threads, each calling loop on</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">different maps.)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br />
<h4 style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; font-weight: 100; line-height: 24px; margin: 0.8em 0px; padding: 0px;">
4. Methods a dispatcher subclass should implement</h4>
<span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">loop() needs the dispatcher to implement some methods:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; . readable(): should return True, if you want the fd to be observed for read events;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; . writable(): should return True, if you want the fd to be observed for write events;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">If either readable or writable returns True, the corresponding fd will be examined</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">for errors also. Obviously, it makes no sense to have a dispatcher</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">which returns False for both readable and writable.</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">Some other methods that loop calls on dispatchers are:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">. handle_read: socket is readable; dispatcher.recv() can be used to actually get the data</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">. handle_write: socket is writable; dispatcher.send(data) can be used to actually send the data</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">. handle_error: socket encountered an error</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">. handle_expt: socket received OOB data (not really used in practice)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">. handle_close: socket was closed remotely or locally</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">For server dispatchers, loop calls one more event:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">. handle_accept:&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; a new incoming connection can be accept()ed.&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; Call the accept() method really accept the connection.&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; To create a server socket, call the bind() and listen() methods on it first.</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">Client sockets get this event:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">. handle_connect: connection to remote endpoint has been made.&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; To initiate the connection, first call the connect() method on it.</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">Client sockets are discussed in the asyncore documentation so I will not discuss them here.</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">Other socket methods are available in dispatcher: create_socket,</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">close, set_resue_addr. They are not called by loop but are available</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">so that your code can call them when it needs to create a new socket, close an existing socket,&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">and tell the OS to set the SO_REUSEADDR flag on the server socket.</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br />
<h4 style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; font-weight: 100; line-height: 24px; margin: 0.8em 0px; padding: 0px;">
5. How to write a server using asyncore</h4>
<span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">The standard library documentation gives a client example, but not a</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">server example. Here are some notes on the latter.</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">1. Subclass dispatcher to create a listening socket</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">2. In its handle_accept method, create new dispatchers. They’ll get added to the global socket map.</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">Note: the handlers must not block or take too much time… or the server won’t be concurrent.&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">This is because when multiple sockets get an event, loop calls their dispatchers one-by-one, in the same thread.</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">The socket-like functions that dispatcher extends should not be bypassed in order to access the low level socket functions.&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">They do funky things to detect higher level events. For e.g., how does asyncore figure out that the socket is closed?&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">If I remember correctly, there are two ways to detect whether a non-blocking socket is closed:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">select() returns a read event, but when you call recv()/read() you get zero bytes;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">you call send()/write() and it fails with an error (sending zero bytes is not an error).</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">(I wish I had a copy of Unix Network Programming by Stevens handy</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">right now.) dispatcher will detect both events above and if any one of them occurs, will call handle_close.&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">This frees you from having to look at low-level events, and think in terms of higher level events.</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">The code for a server based on asyncore is below:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">asyncore_echo_server.py</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">import logging</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">import asyncore</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">import socket</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">logging.basicConfig(level=logging.DEBUG, format="%(created)-15s %(msecs)d %(levelname)8s %(thread)d %(name)s %(message)s")</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">log &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = logging.getLogger(__name__)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">BACKLOG &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = 5</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">SIZE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= 1024</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">class EchoHandler(asyncore.dispatcher):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; def __init__(self, conn_sock, client_address, server):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; self.server &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = server</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; self.client_address &nbsp; &nbsp; = client_address</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; self.buffer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = ""</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; # We dont have anything to write, to start with</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; self.is_writable &nbsp; &nbsp; &nbsp; &nbsp;= False</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; # Create ourselves, but with an already provided socket</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; asyncore.dispatcher.__init__(self, conn_sock)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; log.debug("created handler; waiting for loop")</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; def readable(self):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; return True &nbsp; &nbsp; # We are always happy to read</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; def writable(self):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; return self.is_writable # But we might not have</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # anything to send all the time</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; def handle_read(self):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; log.debug("handle_read")</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; data = self.recv(SIZE)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; log.debug("after recv")</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; if data:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log.debug("got data")</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.buffer += data</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.is_writable = True &nbsp;# sth to send back now</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; else:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log.debug("got null data")</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; def handle_write(self):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; log.debug("handle_write")</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; if self.buffer:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sent = self.send(self.buffer)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log.debug("sent data")</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.buffer = self.buffer[sent:]</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; else:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log.debug("nothing to send")</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; if len(self.buffer) == 0:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.is_writable = False</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; # Will this ever get called? &nbsp;Does loop() call</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; # handle_close() if we called close, to start with?</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; def handle_close(self):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; log.debug("handle_close")</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; log.info("conn_closed: client_address=%s:%s" % \</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(self.client_address[0],</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.client_address[1]))</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; self.close()</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; #pass</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">class EchoServer(asyncore.dispatcher):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; allow_reuse_address &nbsp; &nbsp; &nbsp; &nbsp; = False</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; request_queue_size &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= 5</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; address_family &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= socket.AF_INET</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; socket_type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = socket.SOCK_STREAM</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; def __init__(self, address, handlerClass=EchoHandler):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; self.address &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= address</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; self.handlerClass &nbsp; &nbsp; &nbsp; = handlerClass</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; asyncore.dispatcher.__init__(self)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; self.create_socket(self.address_family,</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.socket_type)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; if self.allow_reuse_address:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.set_reuse_addr()</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; self.server_bind()</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; self.server_activate()</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; def server_bind(self):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; self.bind(self.address)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; log.debug("bind: address=%s:%s" % (self.address[0], self.address[1]))</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; def server_activate(self):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; self.listen(self.request_queue_size)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; log.debug("listen: backlog=%d" % self.request_queue_size)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; def fileno(self):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; return self.socket.fileno()</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; def serve_forever(self):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; asyncore.loop()</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; # TODO: try to implement handle_request()</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; # Internal use</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; def handle_accept(self):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; (conn_sock, client_address) = self.accept()</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; if self.verify_request(conn_sock, client_address):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.process_request(conn_sock, client_address)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; def verify_request(self, conn_sock, client_address):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; return True</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; def process_request(self, conn_sock, client_address):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; log.info("conn_made: client_address=%s:%s" % \</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(client_address[0],</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; client_address[1]))</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; self.handlerClass(conn_sock, client_address, self)</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp;</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; def handle_close(self):</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; self.close()</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">and to use it:</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">interface = "0.0.0.0"</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">port = 8080</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">server = asyncore_echo_server.EchoServer((interface, port))</span><br style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px;" /><span style="background-color: white; box-sizing: border-box; color: #454545; font-family: &quot;sans serif&quot;, tahoma, verdana, helvetica; font-size: 16px; line-height: 24px; margin: 0px; padding: 0px;">server.serve_forever()</span>
<br /><p>http://blog.csdn.net/fireroll/article/details/41826901</p>
